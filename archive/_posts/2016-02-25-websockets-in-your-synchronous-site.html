---
title: "Websockets in Your Synchronous Site"
description: "Chris introduces Socketize, a "sockets-as-a-service" layer that helps you implement websockets into apps with zero overhead, then adds them to a PHP script!"
link: "http://www.sitepoint.com/websockets-in-your-synchronous-site/"
saved: "2016-02-25 14:32:00"
---

    <p><em>This article was <a href="http://www.sitepoint.com/introduction-to-sitepoints-peer-review/">peer reviewed</a> by <a href="http://www.sitepoint.com/author/wancheta/">Wern Ancheta</a>. Thanks to all of SitePoint’s peer reviewers for making SitePoint content the best it can be!</em></p>
<p>I’m always yammering on about writing asynchronous PHP code, and for a reason. I think it’s healthy to get fresh perspectives – to be exposed to new programming paradigms.</p>
<p>Asynchronous architecture is common in other programming languages, but it’s only just finding its feet in PHP. The trouble is that this new architecture comes with a cost.</p>
<div class="ArticleBox u-inline"><h3 class="ArticleBox_header t-bg">
                    <span class="ArticleBox_icon fa fa-pencil"></span> More from this author
                 </h3><div class="ArticleBox_content"><ul class="ArticleBox_list t-list"><li><a href="http://www.sitepoint.com/using-the-rulerz-rule-engine-to-smarten-up-playlist-building/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=php&amp;utm_campaign=relatedauthor">Using the RulerZ Rule Engine to Smarten up Playlist Building</a></li><li><a href="http://www.sitepoint.com/memory-performance-boosts-with-generators-and-nikiciter/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=php&amp;utm_campaign=relatedauthor">Memory Performance Boosts with Generators and Nikic/Iter</a></li></ul></div></div>
<p>I don’t talk about that cost enough.</p>
<p>When I recommend frameworks like <a href="https://github.com/icicleio/icicle">Icicle</a>, <a href="http://reactphp.org/">ReactPHP</a>, and <a href="https://github.com/amphp">AMPHP</a>, the obvious place to start with them is to create something new. If you have an existing site (perhaps running through Apache or Nginx), adding daemonised PHP services to your app is probably not as easy as just starting over.</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/02/1456044335Fotolia_96020977_Subscription_Monthly_M-1024x682.jpg" alt="Abstract image of data streaming in parallel"></p>
<p>It takes a lot of work to integrate new, asynchronous features into existing applications. Often there are good reasons and great benefits, but a rewrite is always a hard-sell. Perhaps you can get some of the benefits of parallel execution without using an event loop. Perhaps you can get some of the benefits of web sockets without a new architecture.</p>
<p>I’m going to show you a Sockets-as-a-Service service, called <a href="https://socketize.com/">Socketize</a>. <em>Try saying that a few times, out loud…</em></p>
<p><em>Note: Web sockets involve a fair amount of JavaScript. Fortunately, we don’t need to set up any complicated build chains. You can find the example code for this tutorial <a href="https://github.com/assertchris-tutorials/tutorial-sockets-in-your-synchronous-site/tree/master">here</a>.</em></p>
<h2 id="setup">Setup!</h2>
<p>Let’s set up a simple CRUD example. <a href="https://gist.github.com/assertchris/83a1cb771d62fcb6d2fe">Download the SQL script</a>, and import it to a local database. Then let’s create a JSON endpoint:</p>
<pre class="  language-php"><code class="prism  language-php"><span class="token variable">$action</span> <span class="token operator">=</span> <span class="token string">"/get"</span><span class="token punctuation">;</span>
<span class="token variable">$actions</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"/get"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"PATH_INFO"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"PATH_INFO"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$actions</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$action</span> <span class="token operator">=</span> <span class="token global">$_SERVER</span><span class="token punctuation">[</span><span class="token string">"PATH_INFO"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span>
    <span class="token string">"mysql:host=localhost;dbname=[your_database_name];charset=utf8"</span><span class="token punctuation">,</span>
    <span class="token string">"[your_database_username]"</span><span class="token punctuation">,</span>
    <span class="token string">"[your_database_password]"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">respond</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">print</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token keyword">and</span> exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This code will decide whether a request is being made against a valid endpoint (currently only supporting <code class=" language-php"><span class="token operator">/</span>get</code>). We also establish a connection to the database, and define a method for allowing us to respond to the browser with minimal effort. Then we need to define the endpoint for <code class=" language-php"><span class="token operator">/</span>get</code>:</p>
<pre class="  language-php"><code class="prism  language-php"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$action</span> <span class="token operator">==</span> <span class="token string">"/get"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$statement</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM cards"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$statement</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$rows</span> <span class="token operator">=</span> <span class="token variable">$statement</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">fetchAll</span><span class="token punctuation">(</span><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">FETCH_ASSOC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$rows</span> <span class="token operator">=</span> <span class="token function">array_map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token string">"id"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"name"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>string<span class="token punctuation">)</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token variable">$rows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">respond</span><span class="token punctuation">(</span><span class="token variable">$rows</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code class=" language-php"><span class="token operator">/</span>get</code> is the default action. This is the thing we want this PHP script to do, if nothing else appears to be required. This will actually become more useful as we add functionality. We also define a list of supported actions. You can think of this as a whitelist, to protect the script against strange requests.</p>
<p>Then, we check the <code class=" language-php"><span class="token constant">PATH_INFO</span></code> server property. We’ll see (in a bit) where this info comes from. Just imagine it contains the URL path. So, for <a href="http://localhost:8000/foo/bar">http://localhost:8000/foo/bar</a>, this variable will contain <code class=" language-php"><span class="token operator">/</span>foo<span class="token operator">/</span>bar</code>. If it’s set, and in the array of allowed actions, we override the default action.</p>
<p>Then we define a function for responding to the browser. It’ll set the appropriate JSON content type header, and print a JSON-encoded response, which we can use in the browser.</p>
<p>Then we connect to the database. Your database details will probably be different. Pay close attention to the name of your database, your database username and database password. The rest should be fine as-is.</p>
<p>For the <code class=" language-php"><span class="token operator">/</span>get</code> action, we fetch all rows from the <code class=" language-php">cards</code> table.  Then, for each card, we cast the columns to the appropriate data type (using the <code class=" language-php">array_map</code> function). Finally, we pass these to the <code class=" language-php">respond</code> function.</p>
<p>To run this, and have the appropriate <code class=" language-php"><span class="token constant">PATH_INFO</span></code> data, we can use the built-in PHP development server:</p>
<pre class=" language-sh"><code class="prism  language-sh">$ php -S localhost:8000 server.php
</code></pre>
<p><em>The built-in PHP development server is not good for production applications. Use a proper web server. It’s convenient to use it here, because we don’t need to set up a production server on our local machine to be able to test this code.</em></p>
<p>At this point, you should be able to see the following in a browser:</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/02/1456044936image-01.png" alt="Initial JSON output"></p>
<p>If you’re not seeing this, you probably should try to resolve that before continuing. You’re welcome to use alternative database structures or data, but you’ll need to be careful with the rest of the examples.</p>
<p>Now, let’s make a client for this data:</p>
<pre class="  language-html"><code class="prism  language-html">&lt;!doctype html&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Graterock<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cards<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">&gt;</span></span>
        <span class="token script language-javascript"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8000/get"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> cards <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".cards"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> json<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">var</span> card <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"li"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        card<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> json<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
                        cards<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>We create an empty <code class=" language-php"><span class="token punctuation">.</span>cards</code> list, which we’ll populate dynamically. For that, we use the HTML5 <code class=" language-php">fetch</code> function. It returns promises, which are a compositional pattern for callbacks.</p>
<p><em>This is just about the most technical part of all of this. I promise it’ll get easier, but if you want to learn more about <code class=" language-php">fetch</code>, check out <a href="https://developer.mozilla.org/en/docs/Web/API/Fetch_API">https://developer.mozilla.org/en/docs/Web/API/Fetch_API</a>. It works in recent versions of Chrome and Firefox, so use those to ensure these examples work!</em></p>
<p>We can work this client into our PHP server script:</p>
<pre class="  language-php"><code class="prism  language-php"><span class="token variable">$action</span> <span class="token operator">=</span> <span class="token string">"/index"</span><span class="token punctuation">;</span>
<span class="token variable">$actions</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"/index"</span><span class="token punctuation">,</span> <span class="token string">"/get"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">
// ...
</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$action</span> <span class="token operator">==</span> <span class="token string">"/index"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-type: text/html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">print</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> exit<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now we can load the client page, and get a list of cards, all from the same script. We don’t even need to change how we run the PHP development server – this should just work!</p>
<h2 id="a-case-for-web-sockets">A case for web sockets</h2>
<p>This is all pretty standard PHP/JavaScript stuff. Well, we are using a new JavaScript feature, but it’s pretty much the same as <code class=" language-php">$<span class="token punctuation">.</span>ajax</code>.</p>
<p>If we wanted to add realtime functionality to this, there are a few tricks we could try. Say we wanted to add realtime card removal; we could use Ajax requests to remove cards, and Ajax polling to refresh other clients automatically.</p>
<p>This would work, but it would also add significant traffic to our HTTP server (even for duplicate responses).</p>
<p>Alternatively, we could open persistent connections between browsers and the server. We could then push new data from the server, and avoid polling continuously. These persistent connections can be web sockets, but there’s a problem…</p>
<p>PHP was created, and is mostly used, to serve requests quickly. Most scripts and applications aren’t designed to be long-running processes. Because of this, conventional PHP scripts and applications are really inefficient at holding many connections open at once.</p>
<p>This limitation often pushes developers towards other platforms (like NodeJS), or towards new architectures (like those provided by Icicle, ReactPHP, and AMPHP). This is one problem Socketize aims to solve.</p>
<h2 id="socketize-to-the-rescue">Socketize to the rescue!</h2>
<p><em>For brevity, we’re going to use the un-authenticated version of Socketize. This means we’ll be able to read and write data without authenticating each user. Socketize supports authentication, and that’s the recommended (and even preferred) method.</em></p>
<p>Create a Socketize account, by going to <a href="https://socketize.com/register">https://socketize.com/register</a>:</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/02/1456044928image-02-1024x571.png" alt="Socketize account creation"></p>
<p>Then, go to <a href="https://socketize.com/dashboard/member/payload/generate">https://socketize.com/dashboard/member/payload/generate</a>, and generate a key for <code class=" language-php">admin</code>. Note this down. Go to <a href="https://socketize.com/dashboard/account/application">https://socketize.com/dashboard/account/application</a> for your account key (“Public Key”). Now we need to add some new JavaScript to our HTML page:</p>
<pre class="  language-html"><code class="prism  language-html"><span class="token script language-javascript"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://socketize.com/v1/socketize.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
<span class="token script language-javascript"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>application/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"public_key"</span><span class="token punctuation">:</span> <span class="token string">"[your_public_key]"</span><span class="token punctuation">,</span>
        <span class="token string">"auth_params"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
            <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token string">"[your_admin_key]"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> socketize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socketize<span class="token punctuation">.</span>client</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

    socketize<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> user <span class="token operator">=</span> socketize<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></span>
</code></pre>
<p>If you replace <code class=" language-php"><span class="token punctuation">[</span>your_public_key<span class="token punctuation">]</span></code> and <code class=" language-php"><span class="token punctuation">[</span>your_admin_key<span class="token punctuation">]</span></code> with the appropriate keys, and refresh the page, you should see a console message: “[Socketize] Connection established!”. You should also see an object describing the Socketize user account which is logged in. Note the user <code class=" language-php">id</code>.</p>
<p>What does this mean? Our HTML page is now connected to the Socketize database (for our account). We can read and write from named lists of messages. Let’s change our server script to write the initial list of cards to a named Socketize list. All Socketize API requests take the form of:</p>
<pre class="  language-bash"><code class="prism  language-bash">curl <span class="token string">"https://socketize.com/api/[method]?[parameters]"</span>
    <span class="token operator">-</span>u <span class="token punctuation">[</span>your_public_key<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token punctuation">[</span>your_private_key<span class="token punctuation">]</span>
    <span class="token operator">-</span>H <span class="token string">"Accept: application/vnd.socketize.v1+json"</span>
</code></pre>
<p>We can create a <code class=" language-php">request</code> function, to simplify this process:</p>
<pre class="  language-php"><code class="prism  language-php"><span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token variable">$method</span><span class="token punctuation">,</span> <span class="token variable">$endpoint</span><span class="token punctuation">,</span> <span class="token variable">$parameters</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$public</span> <span class="token operator">=</span> <span class="token string">"[your_public_key]"</span><span class="token punctuation">;</span>
    <span class="token variable">$private</span> <span class="token operator">=</span> <span class="token string">"[your_private_key]"</span><span class="token punctuation">;</span>

    <span class="token variable">$auth</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string">"{$public}:{$private}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$context</span> <span class="token operator">=</span> <span class="token function">stream_context_create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string">"http"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token string">"method"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$method</span><span class="token punctuation">,</span>
            <span class="token string">"header"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
                <span class="token string">"Authorization: Basic {$auth}"</span><span class="token punctuation">,</span>
                <span class="token string">"Accept: application/vnd.socketize.v1+json"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string">"https://socketize.com/api/{$endpoint}?{$parameters}"</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token variable">$context</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This method abstracts the common code for using the endpoints we’ve set up. We can see it in action, with the following requests:</p>
<pre class="  language-php"><code class="prism  language-php"><span class="token variable">$json</span> <span class="token operator">=</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string">"id"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">"name"</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">"Mysterious Challenger"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>
    <span class="token string">"PUT"</span><span class="token punctuation">,</span>
    <span class="token string">"push_on_list"</span><span class="token punctuation">,</span>
    <span class="token string">"key=[your_user_id]:cards&amp;value={$json}"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">request</span><span class="token punctuation">(</span>
    <span class="token string">"GET"</span><span class="token punctuation">,</span>
    <span class="token string">"get_list_items"</span><span class="token punctuation">,</span>
    <span class="token string">"key=[your_user_id]:cards"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em>It’s probably best to use a robust HTTP request library, like <a href="http://guzzlephp.org/">GuzzlePHP</a>, to make requests to third-party services. There’s also an official PHP SDK at: <a href="https://github.com/socketize/rest-php">https://github.com/socketize/rest-php</a>, but I prefer just to use these concise methods against the JSON API.</em></p>
<p>The <code class=" language-php">request</code> function takes an HTTP request method, Socketize API endpoint and query-string parameter. You’ll need to replace <code class=" language-php"><span class="token punctuation">[</span>your_public_key<span class="token punctuation">]</span></code>, <code class=" language-php"><span class="token punctuation">[</span>your_private_key<span class="token punctuation">]</span></code>, and <code class=" language-php"><span class="token punctuation">[</span>your_user_id<span class="token punctuation">]</span></code> with the correct values. The two example calls should then work for you. <code class=" language-php">cards</code> is the name of the list to which we write this card object. You can think of Socketize like an HTTP version of an object store.</p>
<p>We can adjust our HTML page to pull items from this list. While we’re at it, we can add a button to remove unwanted cards:</p>
<pre class="  language-js"><code class="prism  language-js"><span class="token keyword">var</span> socketize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socketize<span class="token punctuation">.</span>client</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cards <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">".cards"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cards<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">".card .remove"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        socketize<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"removed"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketize<span class="token punctuation">.</span><span class="token function">updateListItem</span><span class="token punctuation">(</span><span class="token string">"cards"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

socketize<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"removed"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>_id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> items <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">".card"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> items<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>_id <span class="token operator">==</span> _id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

socketize<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> user <span class="token operator">=</span> socketize<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    socketize<span class="token punctuation">.</span><span class="token function">getListItems</span><span class="token punctuation">(</span><span class="token string">"cards"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> json<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> name <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"span"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                name<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">;</span>
                name<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> json<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>

                <span class="token keyword">var</span> remove <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                remove<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>_id <span class="token operator">=</span> json<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_id<span class="token punctuation">;</span>
                remove<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">"remove"</span><span class="token punctuation">;</span>
                remove<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"remove"</span><span class="token punctuation">;</span>
                remove<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">"#"</span><span class="token punctuation">;</span>

                <span class="token keyword">var</span> card <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"li"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                card<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>_id <span class="token operator">=</span> json<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>_id<span class="token punctuation">;</span>
                card<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"card"</span><span class="token punctuation">;</span>
                card<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                card<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>remove<span class="token punctuation">)</span><span class="token punctuation">;</span>

                cards<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>card<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em>The <code class=" language-php">match</code> method works in recent versions of Chrome and Firefox. It’s not the only way to do it, but it is much cleaner than the alternative.</em></p>
<p>In this example, we add a click event listener, intercepting clicks on <code class=" language-php"><span class="token punctuation">.</span>remove</code> elements. This is called event delegation, and it’s super efficient! This way we don’t have to worry about removing event listeners on each <code class=" language-php"><span class="token punctuation">.</span>remove</code> element.</p>
<p>Each time a <code class=" language-php"><span class="token punctuation">.</span>remove</code> element is clicked, we trigger an update to the Socketize list. At the same time, we publish a <code class=" language-php">removal</code> event. We also listen for <code class=" language-php">removal</code> events, so that we can update our list if other users remove cards.</p>
<p>We can update the <code class=" language-php">dataset</code> properties of elements. These are the JavaScript representation of <code class=" language-php">data<span class="token operator">-</span><span class="token operator">*</span></code> HTML attributes. This way, we can store the Socketize <code class=" language-php">_id</code> of each card. Finally, we adjust the code to create new elements, and append the generated elements to the <code class=" language-php"><span class="token punctuation">.</span>cards</code> element.</p>
<h2 id="where-do-we-go-from-here">Where do we go from here?</h2>
<p>This tiny example should illustrate how to begin doing useful stuff with Socketize. We added web socket communication (reading and writing to named lists, and publishing ad-hoc types of events). What’s awesome is that we did this without significantly altering our server-side code. We didn’t have to re-write for an event-loop. We just added a function or two, and we could push events to the browser.</p>
<p>Think of the interesting things you could do with this. Every time you save a database record, you can push an event to the browser. You can connect gamers to each other. You can alert conference speakers when they are close to attendees with questions. All of this in a traditional PHP codebase.</p>
<p>If you want to get better at this stuff, perhaps consider making an interface for adding and reordering cards. If you have questions, or can think of other interesting uses for this kind of persistent communication; leave a comment below.</p>
  