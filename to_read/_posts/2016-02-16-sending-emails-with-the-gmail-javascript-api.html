---
title: "Sending Emails with the Gmail JavaScript API"
description: "Jamie Shields shows how to use the Gmail JavaScript API to send email, and in so doing creates a customizable JavaScript app to help you manage your inbox."
link: "http://www.sitepoint.com/sending-emails-gmail-javascript-api/"
saved: "2016-02-16 15:43:00"
---

    <p><em>This article was peer reviewed by <a href="http://www.sitepoint.com/author/scodrington">Simon Codrington</a>. Thanks to all of SitePoint’s peer reviewers for making SitePoint content the best it can be!</em></p>
<p>In a <a href="http://www.sitepoint.com/mastering-your-inbox-with-gmail-javascript-api/">previous article</a>, I demonstrated how to build a basic Gmail inbox and message viewing app using the <a href="https://developers.google.com/gmail/api/">Gmail JavaScript API</a>. Today I’m going to enhance that app with email sending capability using Gmail’s powerful back-end. We’ll end up with a customizable app which can display recent messages, allow the composition of new messages and allow us to reply to specific messages.</p>
<p>It’s not necessary to have read the previous article to follow along with this one (although it will give you a deeper understanding of the subject matter). As ever, the complete source code for this article can be found on <a href="https://github.com/sitepoint-editors/gmail-api-javascript-example">our GitHub repo</a> (in the folder <code class=" language-javascript"><span class="token number">02</span> <span class="token operator">-</span> Sending mail</code>).</p>
<h2 id="enablingthegmailapionyourgoogleaccount">Enabling the Gmail API on Your Google Account</h2>
<div class="ArticleBox u-inline"><h3 class="ArticleBox_header t-bg">
                    <span class="ArticleBox_icon fa fa-pencil"></span> More from this author
                 </h3><div class="ArticleBox_content"><ul class="ArticleBox_list t-list"><li><a href="http://www.sitepoint.com/overview-javascript-templating-engines/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=javascript&amp;utm_campaign=relatedauthor">An Overview of JavaScript Templating Engines</a></li><li><a href="http://www.sitepoint.com/mastering-your-inbox-with-gmail-javascript-api/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=javascript&amp;utm_campaign=relatedauthor">Mastering Your Inbox with the Gmail JavaScript API</a></li></ul></div></div>
<p>The first step is to set up the Gmail API on your Google account. This will allow us to create applications which utilise Gmail functionality. Since we last looked at the Gmail API, Google have changed the user interface for the API management console — so here’s a quick update on how to create the necessary Gmail API credentials.</p>
<p>Navigate to the <a href="https://console.developers.google.com/">Google Developer Console</a> and create a project.  Clicking <em>Create</em> will take us to the new project dashboard interface. From here we need to pop out the hamburger navigation menu and choose <em>API Manager</em>, then in the sidebar on the left we need to choose <em>Credentials</em>, before clicking on the <em>New credentials</em> button on the following page.</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/12/1450874106new-credentials.jpg" alt="New credentials button"></p>
<p>Now we need to create two sets of credentials: a browser API key and an OAuth client ID.</p>
<p>For the browser API key select <em>API key</em> then <em>Browser key</em>. On the following page we need only fill in the <em>name</em> field. However, for production I’d recommend adding a HTTP referrer (this will prevent abuse of our API key from non-authorized domains). Click <em>Create</em> and Google will generate an API key.</p>
<p>For the OAuth client ID, click once more on <em>New credentials</em> and select <em>OAuth client ID</em>. Select <em>Web application</em> as the application type and enter at least one authorized JavaScript origin. For a local development environment this will likely be http://localhost or similar. We do not need to enter an authorized redirect URI. Clicking <em>Create</em> will generate a client ID and client secret.</p>
<p>Once we’ve filled in the necessary fields we should be able to see our credentials back in the <em>Credentials</em> section. Keep this info open in a browser tab for the next step.</p>
<h2 id="initialsetup">Initial Setup</h2>
<h3 id="grabacopyofthecode">Grab a Copy of the Code</h3>
<p>Now that the API credentials are set up we should check out the <a href="https://github.com/sitepoint-editors/gmail-api-javascript-example">source code of the existing demo application</a>.</p>
<pre class=" language-bash"><code class="bash  language-bash"><span class="token function">git</span> clone <span class="token function">git</span>@github<span class="token punctuation">.</span>com<span class="token punctuation">:</span>sitepoint<span class="token operator">-</span>editors<span class="token operator">/</span>gmail<span class="token operator">-</span>api<span class="token operator">-</span>javascript<span class="token operator">-</span>example<span class="token punctuation">.</span><span class="token function">git</span>
</code></pre>
<p>The folder <code class=" language-javascript"><span class="token number">01</span> <span class="token operator">-</span> Basic client</code> contains the code from the previous article. This is what we’re interested in.</p>
<h3 id="enterourcredentials">Enter Our Credentials</h3>
<p>And we should enter our credentials in <code class=" language-javascript">index<span class="token punctuation">.</span>html</code>:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">var</span> clientId <span class="token operator">=</span> <span class="token string">'xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> apiKey <span class="token operator">=</span> <span class="token string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="tweaktheauthenticationscopes">Tweak the Authentication Scopes</h3>
<p>Finally, we should tweak the <a href="https://developers.google.com/gmail/api/auth/scopes">authentication scopes</a>. Previously we required read-only access to the users’ Gmail account. However, sending an email requires further permissions. Modify the scopes variable definition in the <code class=" language-javascript">index<span class="token punctuation">.</span>html</code> as follows (note that the scopes variable is a space-separated string):</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">var</span> scopes <span class="token operator">=</span>
  <span class="token string">'https://www.googleapis.com/auth/gmail.readonly '</span><span class="token operator">+</span>
  <span class="token string">'https://www.googleapis.com/auth/gmail.send'</span><span class="token punctuation">;</span>
</code></pre>
<p>As mentioned in the previous article, it’s always best practice to request the bare minimum permissions when working with someone else’s data — especially something as sensitive as their email account. These two scopes are all we need for this application. Strangely there is a similarly named scope (<code class=" language-javascript">compose</code>) which allows much greater access than we require.</p>
<h3 id="testthatitsworking">Test That It’s Working</h3>
<p>Navigate to http://localhost/gmail-api-javascript-example (or wherever you have placed your <code class=" language-javascript">index<span class="token punctuation">.</span>html</code> file). If things have gone according to plan, the application should ask us for authorization. Once it’s been authorized, we should see something like this:</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/09/14425796211441380125gmail-app.gif" alt="Gmail demo app in action"></p>
<h2 id="sendinganemail">Sending an Email</h2>
<p>Now we’ve got the required permissions we can go ahead with the first step — tweaking the UI to add a compose button. This button will be positioned in the top right-hand corner of the interface (the <code class=" language-javascript">pull<span class="token operator">-</span>right</code> Boostrap class helps with the positioning in this instance).</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/01/1452630019compose-button.jpg" alt="Compose button"></p>
<pre class=" language-markup"><code class="markup  language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#compose-modal<span class="token punctuation">"</span></span>
   <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal<span class="token punctuation">"</span></span>
   <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>compose-button<span class="token punctuation">"</span></span>
   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary pull-right hidden<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Compose<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The compose button is not displayed on the interface by default. This is so that it only appears once the user has authenticated. To enable this functionality we need to remove the <code class=" language-javascript">hidden</code> class from the element at the same time as we remove the <code class=" language-javascript">hidden</code> class from the table which displays the inbox. This means that we should amend our <code class=" language-javascript"><span class="token function">handleAuthResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function to add the following just after the <code class=" language-javascript"><span class="token function">loadGmailApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> call:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">"hidden"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The Compose button will simply open a modal, which we’re also going to add directly into the DOM.</p>
<pre class=" language-markup"><code class="markup  language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal fade<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>compose-modal<span class="token punctuation">"</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dialog<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-dialog modal-lg<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-header<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Close<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token entity" title="×">&amp;times;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Compose<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onsubmit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return sendEmail();<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-body<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>compose-to<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>To<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>compose-subject<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Subject<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>compose-message<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Message<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-footer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-default<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Close<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>send-button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The result should look like this:</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2015/12/1450878674compose-screenshot.png" alt="Compose modal"></p>
<p>This is a standard Bootstrap-styled form which calls the <code class=" language-javascript"><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function on submit.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#send-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'disabled'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">sendMessage</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token string">'To'</span><span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-to'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'Subject'</span><span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-subject'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    composeTidy
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The first thing we do when <code class=" language-javascript"><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> is called is disable the send button. It’s important to disable the form submit functionality whenever submission logic is carried out via Ajax, as this prevents the user from re-clicking the button whilst a request is in progress. Next we grab the values from our compose form and hand everything to <code class=" language-javascript"><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code>. Finally we return <code class=" language-javascript"><span class="token keyword">false</span></code>. Returning <code class=" language-javascript"><span class="token keyword">false</span></code> from an <code class=" language-javascript">onsubmit</code> function is important when processing the form via Ajax — it prevents the form from submitting and reloading the page.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>headers_obj<span class="token punctuation">,</span> message<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">var</span> email <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> header <span class="token keyword">in</span> headers_obj<span class="token punctuation">)</span>
    email <span class="token operator">+</span><span class="token operator">=</span> header <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">": "</span><span class="token operator">+</span>headers_obj<span class="token punctuation">[</span>header<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"\r\n"</span><span class="token punctuation">;</span>

  email <span class="token operator">+</span><span class="token operator">=</span> <span class="token string">"\r\n"</span> <span class="token operator">+</span> message<span class="token punctuation">;</span>

  <span class="token keyword">var</span> sendRequest <span class="token operator">=</span> gapi<span class="token punctuation">.</span>client<span class="token punctuation">.</span>gmail<span class="token punctuation">.</span>users<span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'userId'</span><span class="token punctuation">:</span> <span class="token string">'me'</span><span class="token punctuation">,</span>
    <span class="token string">'resource'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">'raw'</span><span class="token punctuation">:</span> window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\+/g</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> sendRequest<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This function is where we interact with the Gmail API. It accepts an object of email headers, the email body and a callback function.</p>
<p>We start by building up the <a href="https://tools.ietf.org/html/rfc5322">RFC 5322</a> email message (this includes the headers). <a href="http://wesmorgan.blogspot.co.uk/2012/07/understanding-email-headers-part-ii.html">Articles have suggested</a> that the <code class=" language-javascript">Date</code> and <code class=" language-javascript">From</code> headers are required for the message to be valid by the RFC 5322 specification. However I’ve found those headers are not required when using the Gmail API, as Gmail will automatically add those headers for us. The Gmail API also adds it’s own <code class=" language-javascript">Message<span class="token operator">-</span>Id</code>.</p>
<p>Once we’ve got the email message prepared we can send it to the Gmail API, specifically to the <a href="https://developers.google.com/gmail/api/v1/reference/users/messages/send">Users.messages: send endpoint</a>. Something very important to note here is that <strong>we must specify the email message within an object named <code class=" language-javascript">resource</code>, not an object named <code class=" language-javascript">message</code></strong>. <a href="https://developers.google.com/gmail/api/v1/reference/users/messages/send#examples">Google’s documented JavaScript example</a> states that the object should be named <code class=" language-javascript">message</code> — this is incorrect and will not work. Note that the email message needs to be base-64 encoded, we use <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/btoa">window.btoa()</a> for this. Also note that Google’s base-64 implementation differs from what <code class=" language-javascript">window<span class="token punctuation">.</span><span class="token function">btoa</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> and <code class=" language-javascript">window<span class="token punctuation">.</span><span class="token function">atob</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> provide – so we need to carry out some character replacements after the encoding. Specifically we must replace <code class=" language-javascript"><span class="token operator">+</span></code> with <code class=" language-javascript"><span class="token operator">-</span></code> and <code class=" language-javascript"><span class="token operator">/</span></code> with <code class=" language-javascript">_</code>.</p>
<p>Finally we’ll execute the request, passing the callback function.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">composeTidy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-modal'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">'hide'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-to'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-subject'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#compose-message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#send-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'disabled'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code class=" language-javascript"><span class="token function">composeTidy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> callback function is very basic. It simply hides the compose modal, clears the input fields and then re-enables the Send button.</p>
<h2 id="replyingtoanemail">Replying to an Email</h2>
<p>Now that we can read emails and compose new emails, the next logical step is to implement replying to emails.</p>
<p>As before, the first thing we do is modify the UI to provide access to this new functionality. So we’re going to add a modal footer to the message view modal we implemented previously.</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/01/1452630014reply-button.jpg" alt="Reply button"></p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">var</span> reply_to <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getHeader</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> <span class="token string">'Reply-to'</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token operator">==</span> <span class="token string">''</span> <span class="token operator">?</span>
  <span class="token function">getHeader</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> <span class="token string">'Reply-to'</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
  <span class="token function">getHeader</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> <span class="token string">'From'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\"/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> reply_subject <span class="token operator">=</span> <span class="token string">'Re: '</span><span class="token operator">+</span><span class="token function">getHeader</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> <span class="token string">'Subject'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\"/g</span><span class="token punctuation">,</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'body'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token string">'&lt;div class="modal-footer"&gt;\
    &lt;button type="button" class="btn btn-default" data-dismiss="modal"&gt;Close&lt;/button&gt;\
    &lt;button type="button" class="btn btn-primary reply-button" data-dismiss="modal" data-toggle="modal" data-target="#reply-modal"\
    onclick="fillInReply(\
      \''</span><span class="token operator">+</span>reply_to<span class="token operator">+</span><span class="token string">'\', \
      \''</span><span class="token operator">+</span>reply_subject<span class="token operator">+</span><span class="token string">'\', \
      \''</span><span class="token operator">+</span><span class="token function">getHeader</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>payload<span class="token punctuation">.</span>headers<span class="token punctuation">,</span> <span class="token string">'Message-ID'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'\'\
      );"\
    &gt;Reply&lt;/button&gt;\
  &lt;/div&gt;'</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The footer offers a Reply button which passes all required details (to, subject, message ID) to a new reply modal, and then opens the new modal. The <code class=" language-javascript">to</code> parameter requires a bit of special attention, so this is defined prior to the markup. We should always attempt to use the <code class=" language-javascript">Reply<span class="token operator">-</span>To</code> header for the <code class=" language-javascript">to</code> parameter, but if that’s not provided then the <code class=" language-javascript">From</code> header will suffice. We also need to encode any double quotes as a HTML entity to prevent our own markup from breaking. The <code class=" language-javascript">subject</code> parameter requires the same double quote escaping, and a “Re: ” prefix.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">fillInReply</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> subject<span class="token punctuation">,</span> message_id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-to'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-subject'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>subject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-message-id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>message_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code class=" language-javascript"><span class="token function">fillInReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function, which passes the fields to the reply modal, is very simple. It just passes the data it’s given directly into the new reply modal input fields.</p>
<p><img src="http://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/01/1452630009reply-modal.jpg" alt="Reply modal"></p>
<pre class=" language-markup"><code class="markup  language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal fade<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-modal<span class="token punctuation">"</span></span> <span class="token attr-name">tabindex</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>-1<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dialog<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-dialog modal-lg<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-header<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal<span class="token punctuation">"</span></span> <span class="token attr-name">aria-label</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Close<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">aria-hidden</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token entity" title="×">&amp;times;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-title<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Reply<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">onsubmit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return sendReply();<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-message-id<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-body<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-to<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control disabled<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-subject<span class="token punctuation">"</span></span> <span class="token attr-name">disabled</span> <span class="token punctuation">/&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-message<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Message<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">required</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal-footer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-default<span class="token punctuation">"</span></span> <span class="token attr-name">data-dismiss</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>modal<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Close<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>reply-button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Send<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>The reply modal is quite similar to the compose modal. The main difference being the hidden field which stores the message ID. This is required to thread emails correctly in email clients — matching the subject with a “Re: ” prefix is not enough. Also we’re going to disable the <em>To</em> and <em>Subject</em> fields as they shouldn’t be changed at this point, they are only visible to provide context. Once the reply modal form is submitted the <code class=" language-javascript"><span class="token function">sendReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function is called.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">sendReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'disabled'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">sendMessage</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token string">'To'</span><span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-to'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'Subject'</span><span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-subject'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'In-Reply-To'</span><span class="token punctuation">:</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-message-id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    replyTidy
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code class=" language-javascript"><span class="token function">sendReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function is largely the same as <code class=" language-javascript"><span class="token function">sendEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code>, except we now pass through the <code class=" language-javascript">In<span class="token operator">-</span>Reply<span class="token operator">-</span>To</code> header which allows email clients to thread the conversation correctly. The <a href="https://developers.google.com/gmail/api/guides/sending#sending_messages">Google documentation</a> states that the <code class=" language-javascript">References</code> header also needs to be provided, but in our testing it will work without it. Once the reply has been sent the <code class=" language-javascript"><span class="token function">replyTidy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> callback is triggered.</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">replyTidy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-modal'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modal</span><span class="token punctuation">(</span><span class="token string">'hide'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-message'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#reply-button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'disabled'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Again this is largely the same as our <code class=" language-javascript"><span class="token function">composeTidy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> callback from before. However this time it’s not necessary to clear the <em>Subject</em> and <em>To</em> input fields as our <code class=" language-javascript"><span class="token function">fillInReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function will always overwrite them.</p>
<h2 id="closingremarks">Closing Remarks</h2>
<p>We should now have a working app which can display recent messages, allow the composition of new messages and allow us to reply to specific messages.</p>
<p>If you’re interested in taking it further, there is plenty of room for improvement with this app;</p>
<ul>
<li>Staggered authorisation requests so that the user can read their inbox by only agreeing to the <code class=" language-javascript">readonly</code> scope. Then once the user clicks to Compose or Reply, another authorisation request for the <code class=" language-javascript">send</code> scope is prompted.</li>
<li>The compose modal <em>To</em> field should be changed from <code class=" language-javascript">type<span class="token operator">=</span><span class="token string">"email"</span></code> so that the user can enter a name and email address combination (eg. <code class=" language-javascript">Jamie Shields <span class="token operator">&lt;</span>jamie@somewhere<span class="token punctuation">.</span>com<span class="token operator">&gt;</span></code>).</li>
<li>The compose modal <em>To</em> field should auto-complete based on the user’s contact list, and also allow the user to choose a recipient directly from the list.</li>
</ul>
<p>There is also lots of scope for adding new features. Some things I’d like to look at in the future include;</p>
<ul>
<li>Adding email forwarding capability</li>
<li>Adding CC and BCC headers to emails</li>
<li>Ability to view the complete set of headers attached to an email</li>
<li>Ability to send HTML email (with a WYSIWYG editor for composing)</li>
</ul>
<p>If you have any other improvements or suggestions, please feel free to add them in the comments.</p>
<p>And don’t forget, the full source code is available via our <a href="https://github.com/sitepoint-editors/gmail-api-javascript-example">GitHub repo</a>.</p>
  