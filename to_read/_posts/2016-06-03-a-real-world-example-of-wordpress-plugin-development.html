---
title: "A Real World Example of WordPress Plugin Development"
description: "Simon Codrington revisits his article on an Introduction to Plugin Development with this real world example of WordPress Plugin Development. "
link: "https://www.sitepoint.com/real-world-example-wordpress-plugin-development/"
saved: "2016-06-03 14:17:50"
---

    <p>To make the most out of this tutorial, you should have a basic understanding of topics such as <code class=" language-php">actions</code>, <code class=" language-php">filters</code>, <code class=" language-php">shortcodes</code>, <code class=" language-php">widgets</code> and <code class=" language-php">object orientated design</code>.</p>
<p>If you’re interested in brushing up on the basics, you can read my previous article <a href="https://www.sitepoint.com/an-introduction-to-wordpress-plugin-development/">An Introduction to WordPress Plugin Development</a>. It will help you to build a solid understanding of the concepts and ideas we’ll be using throughout this tutorial.</p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/06/1464795300wordpress-plugin.gif" alt="wordpress-plugin" width="512" height="512" class="aligncenter size-full wp-image-131768"></p>
<h2 id="real-world-example-business-locations-list">Real World Example – Business Locations List</h2>
<p></p><div class="ArticleBox u-inline"><h3 class="ArticleBox_header t-bg">
                    <span class="ArticleBox_icon fa fa-pencil"></span> More from this author
                 </h3><div class="ArticleBox_content"><ul class="ArticleBox_list t-list"><li><a href="https://www.sitepoint.com/how-to-perform-single-character-transforms-with-css-and-js/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=wordpress&amp;utm_campaign=relatedauthor">Quick Tip: Single Character Transforms with CSS and JS</a></li><li><a href="https://www.sitepoint.com/what-can-developers-expect-in-android-n/?utm_source=sitepoint&amp;utm_medium=relatedinline&amp;utm_term=wordpress&amp;utm_campaign=relatedauthor">What Can Developers Expect in Android N?</a></li></ul></div></div>
<p>Let’s jump straight into a real world example of how plugins can be used to address issues and add functionality to your website.</p>
<p>Often businesses will want to showcase the various locations or offices that they have. While these locations could be created as pages, it would be better to create them as a content type that matches their unique information and provides the user with an easy interface to display these locations.</p>
<p>While we could build this functionality into our child theme, it is generic enough that we could build it as a plugin to make implementing it into other sites simple and easy. </p>
<p>Our example will cover the development of a plugin that processes and outputs locations. These locations will be a custom content type with additional meta information for storing location specific data. The plugin will also demonstrate the various ways in which you can output your information (such as the individual location page, a location listing widget and a location listing shortcode) </p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/06/1464865051plugin_location_final.jpg" alt="plugin_location_final" class="alignnone size-medium wp-image-131844"></p>
<h3 id="setting-everything-up">Setting Everything Up</h3>
<p>Lets set everything up, jump to to your plugin directory and create the following folder / file structure </p>
<ul>
<li>wp_simple_location_plugin
<ul>
<li>css
<ul>
<li>wp_location_public_styles.css</li>
<li>wp_location_admin_styles.css</li>
</ul>
</li>
<li>inc
<ul>
<li>wp_location_widget.php</li>
<li>wp_location_shortcode.php</li>
</ul>
</li>
<li>wp_simple_location_plugin.php</li>
</ul>
</li>
</ul>
<p>The top level file <code class=" language-php">wp_simple_location_plugin<span class="token punctuation">.</span>php</code> is going to be our main file. It is here we’ll load our styles from our CSS directory and also the additional PHP files from the includes directory. </p>
<h2 id="main-location-class">Main Location Class</h2>
<p>Inside the <code class=" language-php">wp_simple_location_plugin<span class="token punctuation">.</span>php</code> file we’ll define our core functionality for the plugin. We’ll also include our additional files that are needed for the widget and shortcode functionality.</p>
<h3 id="no-direct-access">No Direct Access</h3>
<p>A recommendation is to block direct access to your PHP files by checking if the <code class=" language-php"><span class="token constant">ABSPATH</span></code> variable is defined (if so we terminate execution). Add the following code directly after your opening PHP tag:</p>
<pre class=" language-php"><code class=" language-php"><span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string">'Nope, not accessing this'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="plugin-declaration">Plugin Declaration</h3>
<p>To get our plugin working it needs to have a plugin declaration defined. A plugin declaration is a set of comments that WordPress will look for and contains information about your plugin. This must be included as without it your plugin won’t appear in the WP plugin manager. </p>
<pre class=" language-php"><code class=" language-php"><span class="token delimiter">&lt;?php</span>
<span class="token comment" spellcheck="true">/*
Plugin Name: WordPress Simple Location Plugin
Plugin URI:  https://github.com/simonrcodrington/Introduction-to-WordPress-Plugins---Location-Plugin
Description: Creates an interfaces to manage store / business locations on your website. Useful for showing location based information quickly. Includes both a widget and shortcode for ease of use.
Version:     1.0.0
Author:      Simon Codrington
Author URI:  http://www.simoncodrington.com.au
License:     GPL2
License URI: https://www.gnu.org/licenses/gpl-2.0.html
*/</span>
</code></pre>
<p>You define your plugins name, description, version and other information here. The majority of this will be shown on the plugins administration page when users activate the plugin. </p>
<h4 id="the-wpsimplelocation-class">The wp_simple_location Class</h4>
<p>We now create the shell of the <code class=" language-php">wp_simple_location</code> class. This class will contain a majority of the functionality for this plugin and will be used to hold our properties and methods. </p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">class</span> <span class="token class-name">wp_simple_location</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre>

<p>Since we’ll be using both a widget and a shortcode, the functionality for each has been split into its own file. </p>
<p>Go to the end of the <code class=" language-php">wp_simple_location</code> class and add the following:</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//include shortcodes</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token function">plugin_dir_path</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'inc/wp_location_shortcode.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//include widgets</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token function">plugin_dir_path</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'inc/wp_location_widget.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>This will load both of our files which we’ll look at later.</p>
<h3 id="class-properties">Class Properties</h3>
<p>Class properties are variables that can be accessed from functions within the class. </p>
<p>Declaring properties makes it easier to access commonly used elements.</p>
<p>We only have one property in this function; an array of days that will be used for the trading hours of the location.  Let’s define the value as an empty array as later on we’ll populate it with our values.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//properties</span>
<span class="token keyword">private</span> <span class="token variable">$wp_location_trading_hour_days</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="the-construct-function">The _construct Function</h3>
<p>The <code class=" language-php">_construct</code> function is an important part of the plugin as it acts as the master function, letting us handle and execute other functions. </p>
<p>This function is a <code class=" language-php">magic</code> function; Magic functions are special functions added to PHP5 that are triggered on certain conditions automatically. This function is triggered the instant that our class is instantiated (the class is created and assigned to a variable). </p>
<p>In a plugin you will use this function to add all of your actions, filters and function calls. You could add these hooks outside the class but it’s fine to leave them here.</p>
<p>Copy the following code. We’ll go through each of the elements one at a time so you can see what is happening.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//magic function (triggered on initialization)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'set_location_trading_hour_days'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//sets the default trading hour days (used by the content type)</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'register_location_content_type'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//register location content type</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'add_meta_boxes'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'add_location_meta_boxes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//add meta boxes</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'save_post_wp_locations'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'save_location'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//save location</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'admin_enqueue_scripts'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'enqueue_admin_scripts_and_styles'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//admin scripts and styles</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'wp_enqueue_scripts'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'enqueue_public_scripts_and_styles'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//public scripts and styles</span>
    <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string">'the_content'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'prepend_location_meta_to_content'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//gets our meta data and dispayed it before the content</span>

    <span class="token function">register_activation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'plugin_activate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//activate hook</span>
    <span class="token function">register_deactivation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'plugin_deactivate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//deactivate hook</span>

<span class="token punctuation">}</span>
</code></pre>
<p>The <code class=" language-php">register_activation_hook</code> and <code class=" language-php">register_deactivation_hook</code> functions are used to hook into functions when the plugin is activated or deactivated. We use these hooks to ensure our content type (our locations) have been added correctly and to flush our permalinks (so we can use pretty permalinks)</p>
<h3 id="setting-the-location-trading-hour-days">Setting the Location Trading Hour Days</h3>
<p>Our plugin allows the admin to define the opening and closing times for different days on single location basis. </p>
<p>The backend admin where you enter these details looks at our property <code class=" language-php"><span class="token variable">$wp_location_trading_hour_days</span></code> which contains an array of our days. We need to call the <code class=" language-php">set_location_trading_hour_days</code> function to set the days we want to display location trading hours for. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//set the default trading hour days (used in our admin backend)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_location_trading_hour_days</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//set the default days to use for the trading hours</span>
    <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wp_location_trading_hour_days</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string">'wp_location_trading_hours_days'</span><span class="token punctuation">,</span> 
        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'monday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Monday'</span><span class="token punctuation">,</span>
              <span class="token string">'tuesday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Tuesday'</span><span class="token punctuation">,</span>
              <span class="token string">'wednesday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Wednesday'</span><span class="token punctuation">,</span>
              <span class="token string">'thursday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Thursday'</span><span class="token punctuation">,</span>
              <span class="token string">'friday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Friday'</span><span class="token punctuation">,</span>
              <span class="token string">'saturday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Saturday'</span><span class="token punctuation">,</span>
              <span class="token string">'sunday'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Sunday'</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>      
<span class="token punctuation">}</span>
</code></pre>
<p>When assigning the values of the array we also called the <code class=" language-php">wp_location_trading_hours_days</code> filter. This means that a theme or another plugin could redefine the days that locations are open for business (they might filter the array and add  ‘holidays’ to the array so they can enter a trading hour value for that day).</p>
<h3 id="setting-the-location-trading-hour-days-1">Setting the Location Trading Hour Days</h3>
<p>Here we define our new custom location content type that will be used in our plugin. </p>
<p>We define the labels and arguments for the content type and pass our arguments to the <a href="https://codex.wordpress.org/Function_Reference/register_post_type"><code class=" language-php">register_post_type</code></a> function.</p>
<p><a href="https://codex.wordpress.org/Function_Reference/register_post_type#Parameters">The codex page on custom content types explains all of the options you can specify.</a> For our content type we want basic support for the Title, Editor and Featured Image.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//register the location content type</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register_location_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">//Labels for post type</span>
     <span class="token variable">$labels</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
           <span class="token string">'name'</span>               <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Location'</span><span class="token punctuation">,</span>
           <span class="token string">'singular_name'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Location'</span><span class="token punctuation">,</span>
           <span class="token string">'menu_name'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Locations'</span><span class="token punctuation">,</span>
           <span class="token string">'name_admin_bar'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Location'</span><span class="token punctuation">,</span>
           <span class="token string">'add_new'</span>            <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Add New'</span><span class="token punctuation">,</span> 
           <span class="token string">'add_new_item'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Add New Location'</span><span class="token punctuation">,</span>
           <span class="token string">'new_item'</span>           <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'New Location'</span><span class="token punctuation">,</span> 
           <span class="token string">'edit_item'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Edit Location'</span><span class="token punctuation">,</span>
           <span class="token string">'view_item'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'View Location'</span><span class="token punctuation">,</span>
           <span class="token string">'all_items'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'All Locations'</span><span class="token punctuation">,</span>
           <span class="token string">'search_items'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Search Locations'</span><span class="token punctuation">,</span>
           <span class="token string">'parent_item_colon'</span>  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'Parent Location:'</span><span class="token punctuation">,</span> 
           <span class="token string">'not_found'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'No Locations found.'</span><span class="token punctuation">,</span> 
           <span class="token string">'not_found_in_trash'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'No Locations found in Trash.'</span><span class="token punctuation">,</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//arguments for post type</span>
       <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
           <span class="token string">'labels'</span>            <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$labels</span><span class="token punctuation">,</span>
           <span class="token string">'public'</span>            <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'publicly_queryable'</span><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'show_ui'</span>           <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'show_in_nav'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'query_var'</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'hierarchical'</span>      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
           <span class="token string">'supports'</span>          <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span><span class="token string">'thumbnail'</span><span class="token punctuation">,</span><span class="token string">'editor'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token string">'has_archive'</span>       <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'menu_position'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">,</span>
           <span class="token string">'show_in_admin_bar'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
           <span class="token string">'menu_icon'</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'dashicons-location-alt'</span><span class="token punctuation">,</span>
           <span class="token string">'rewrite'</span>            <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'slug'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'locations'</span><span class="token punctuation">,</span> <span class="token string">'with_front'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">//register post type</span>
       <span class="token function">register_post_type</span><span class="token punctuation">(</span><span class="token string">'wp_locations'</span><span class="token punctuation">,</span> <span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>When you have this you should see a new menu for your post type</p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/06/1464865571plugin_location_context_menu.jpg" alt="plugin_location_context_menu" width="352" height="144" class="alignnone size-full wp-image-131849"></p>

<p>We define a custom meta box that will be displayed on our location page. This box will contain all of our additional fields we want to save as meta data (such as a phone number, email, address).</p>
<p>Inside our function we call the <a href="https://codex.wordpress.org/Function_Reference/add_meta_box"><code class=" language-php"><span class="token function">add_meta_box</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> function and supply our arguments. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//adding meta boxes for the location content type*/</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">add_location_meta_boxes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token function">add_meta_box</span><span class="token punctuation">(</span>
        <span class="token string">'wp_location_meta_box'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//id</span>
        <span class="token string">'Location Information'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//name</span>
        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'location_meta_box_display'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//display function</span>
        <span class="token string">'wp_locations'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//post type</span>
        <span class="token string">'normal'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//location</span>
        <span class="token string">'default'</span> <span class="token comment" spellcheck="true">//priority</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Our third value to <code class=" language-php">add_meta_box</code> is the function that will display the output for the box. We’are calling the <code class=" language-php">location_meta_box_display</code> function which is the next function we’ll add to our class</p>

<p>This is the function that will be called from our location meta box and It displays additional fields that the admin can use to save information about their location.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//display function used for our custom location meta box*/</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">location_meta_box_display</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//set nonce field</span>
    <span class="token function">wp_nonce_field</span><span class="token punctuation">(</span><span class="token string">'wp_location_nonce'</span><span class="token punctuation">,</span> <span class="token string">'wp_location_nonce_field'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//collect variables</span>
    <span class="token variable">$wp_location_phone</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_phone'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wp_location_email</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_email'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$wp_location_address</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_address'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token delimiter">?&gt;</span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span></span>Enter additional information about your location <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>field-container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
        <span class="token php"><span class="token delimiter">&lt;?php</span> 
        <span class="token comment" spellcheck="true">//before main form elementst hook</span>
        <span class="token function">do_action</span><span class="token punctuation">(</span><span class="token string">'wp_location_admin_form_start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token delimiter">?&gt;</span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_phone<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>Contact Phone<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span></span>main contact number<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tel<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_phone<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_phone<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$wp_location_phone</span><span class="token punctuation">;</span><span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_email<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>Contact Email<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span></span>Email contact<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_email<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_email<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$wp_location_email</span><span class="token punctuation">;</span><span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>field<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_address<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>Address<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span></span>Physical address of your location<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_address<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wp_location_address<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$wp_location_address</span><span class="token punctuation">;</span><span class="token delimiter">?&gt;</span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token php"><span class="token delimiter">&lt;?php</span>
        <span class="token comment" spellcheck="true">//trading hours</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wp_location_trading_hour_days</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">echo</span> <span class="token string">'&lt;div class="field"&gt;'</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span></span>Trading Hours <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
                <span class="token keyword">echo</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span></span> Trading hours <span class="token keyword">for</span> the location <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g 9am <span class="token operator">-</span> 5pm<span class="token punctuation">)</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//go through all of our registered trading hour days</span>
                <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wp_location_trading_hour_days</span> <span class="token keyword">as</span> <span class="token variable">$day_key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$day_value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//collect trading hour meta data</span>
                    <span class="token variable">$wp_location_trading_hour_value</span> <span class="token operator">=</span>  <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_trading_hours_'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//dsiplay label and input</span>
                    <span class="token keyword">echo</span> <span class="token string">'&lt;label for="wp_location_trading_hours_'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">.</span> <span class="token string">'"&gt;'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/label&gt;'</span><span class="token punctuation">;</span>
                    <span class="token keyword">echo</span> <span class="token string">'&lt;input type="text" name="wp_location_trading_hours_'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">.</span> <span class="token string">'" id="wp_location_trading_hours_'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">.</span> <span class="token string">'" value="'</span> <span class="token punctuation">.</span> <span class="token variable">$wp_location_trading_hour_value</span> <span class="token punctuation">.</span> <span class="token string">'"/&gt;'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">echo</span> <span class="token string">'&lt;/div&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>       
        <span class="token delimiter">?&gt;</span></span>
    <span class="token php"><span class="token delimiter">&lt;?php</span> 
    <span class="token comment" spellcheck="true">//after main form elementst hook</span>
    <span class="token function">do_action</span><span class="token punctuation">(</span><span class="token string">'wp_location_admin_form_end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token delimiter">?&gt;</span></span>
    <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
    <span class="token delimiter">&lt;?php</span>

<span class="token punctuation">}</span>
</code></pre>
<p>Let’s run through what this function does</p>
<ul>
<li>First it creates a secure nonce field for the meta box (<a href="https://codex.wordpress.org/Function_Reference/wp_nonce_field">nonces are used to verify that a submit action came from the correctly place</a>).</li>
<li>It collects our phone, email and address meta information (if we have any).</li>
<li>Just before the form starts we add the <code class=" language-php">wp_location_admin_form_start</code> action hook. This will let other plugins or themes hook into this location, allowing additional fields or information to be displayed.</li>
<li>Displays the phone, email and address fields (and pre-populates them if we have any previous values).</li>
<li>Displays the list of trading hour days for the location. Here the admin can define the trading hours on a day by day basis. These days can be dynamic as they are attached to the <code class=" language-php">wp_location_trading_hours_days</code> filter. </li>
<li>Just before the form finishes we add the <code class=" language-php">wp_location_admin_form_end</code> action hook. This will let other plugins or the themes hook into this location, allowing additional fields or information to be displayed.</li>
</ul>
<p>You should see your meta box displayed on your location. It should look something like this</p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/06/1464865841plugin_location_background_box.jpg" alt="plugin_location_background_box" width="754" height="487" class="alignnone size-full wp-image-131851"></p>
<h3 id="registering-content-type-and-flushing-re-write-rules-on-activate">Registering Content Type and Flushing Re-write Rules on Activate</h3>
<p>When a plugin first activates you can call a function to perform once off actions. That is what we do with the <code class=" language-php">plugin_activate</code> function.</p>
<p>Even though we register our content type via the <code class=" language-php">init</code> hook, we still need to call the <code class=" language-php">register_location_content_type</code> from within it (to ensure that our content type has been added correctly)</p>
<p>We also flush the rewrite rules so that we can use pretty permalinks for our locations (we can have links such as <code class=" language-php">example<span class="token punctuation">.</span>com<span class="token operator">/</span>location<span class="token operator">/</span>mylocation</code> instead of <code class=" language-php">example<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token operator">?</span>p<span class="token operator">=</span><span class="token number">144</span></code>) </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//triggered on activation of the plugin (called only once)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">plugin_activate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
    <span class="token comment" spellcheck="true">//call our custom content type function</span>
    <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">register_location_content_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//flush permalinks</span>
    <span class="token function">flush_rewrite_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="flushing-re-write-rules-on-deactivation">Flushing Re-write Rules on Deactivation</h3>
<p>Plugin deactivate is triggered when we deactivate our plugin. Since we’re removing the plugin and the plugin defined a custom content type, we want to use this chance to flush our re-write rules for consistency. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//trigered on deactivation of the plugin (called only once)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">plugin_deactivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//flush permalinks</span>
    <span class="token function">flush_rewrite_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>Since we’re defining additional meta information for each location, we create a function that handles the display of this extra information when viewing the single location page.</p>
<p>The <code class=" language-php">prepend_location_meta_to_content</code> function is hooked onto the <code class=" language-php">the_content</code> filter which means we can add our additional information before the pages main content. </p>
<pre class=" language-php"><code class=" language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">prepend_location_meta_to_content</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token keyword">global</span> <span class="token variable">$post</span><span class="token punctuation">,</span> <span class="token variable">$post_type</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//display meta only on our locations (and if its a single location)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$post_type</span> <span class="token operator">==</span> <span class="token string">'wp_locations'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_singular</span><span class="token punctuation">(</span><span class="token string">'wp_locations'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//collect variables</span>
        <span class="token variable">$wp_location_id</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">;</span>
        <span class="token variable">$wp_location_phone</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_phone'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$wp_location_email</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_email'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$wp_location_address</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span><span class="token string">'wp_location_address'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//display</span>
        <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;section class="meta-data"&gt;'</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//hook for outputting additional meta data (at the start of the form)</span>
        <span class="token function">do_action</span><span class="token punctuation">(</span><span class="token string">'wp_location_meta_data_output_start'</span><span class="token punctuation">,</span><span class="token variable">$wp_location_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;p&gt;'</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//phone</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Location Phone<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span> <span class="token string">' . $wp_location_phone . '</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//email</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_email</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Location Email<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span> <span class="token string">' . $wp_location_email . '</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//address</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_address</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Location Address<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span> <span class="token string">' . $wp_location_address . '</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//location</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wp_location_trading_hour_days</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;p&gt;'</span><span class="token punctuation">;</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Location Trading Hours <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
            <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wp_location_trading_hour_days</span> <span class="token keyword">as</span> <span class="token variable">$day_key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$day_value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$trading_hours</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">,</span> <span class="token string">'wp_location_trading_hours_'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;span class="day"&gt;'</span> <span class="token punctuation">.</span> <span class="token variable">$day_key</span> <span class="token punctuation">.</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hours<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span><span class="token string">' . $trading_hours . '</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//hook for outputting additional meta data (at the end of the form)</span>
        <span class="token function">do_action</span><span class="token punctuation">(</span><span class="token string">'wp_location_meta_data_output_end'</span><span class="token punctuation">,</span><span class="token variable">$wp_location_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/section&gt;'</span><span class="token punctuation">;</span>
        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$html</span><span class="token punctuation">;</span>  


    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>Let’s run through what this function does:</p>
<ul>
<li>Since the function is added to the <code class=" language-php">the_content</code> hook, it will run every time a page is loaded. As such we use the global <code class=" language-php"><span class="token variable">$post</span></code> and <code class=" language-php"><span class="token variable">$post_type</span></code> variables to ensure we’re on a single location page only</li>
<li>We collect our basic location information such as the email, phone and address.</li>
<li>Just as we’re about to display our meta information we call the <code class=" language-php">wp_location_meta_data_output_start</code> action hook. This action will let other plugins or themes hook into the starting output of the meta information (if someone added a new field to the location this hook can be used to display the saved info).</li>
<li>We output the email, phone and address information.</li>
<li>We go through our <code class=" language-php">wp_location_trading_hour_days</code>variable and see if we have days defined. If we do we loop through all of them and collect its trading hours and display them.</li>
<li>Just before we finish all of our output we call the <code class=" language-php">wp_location_meta_data_output_end</code> action. This action will let someone output additional information before the closing of the location meta.</li>
</ul>
<h3 id="getting-the-location-listing-out">Getting the Location Listing Out</h3>
<p>We create a function who’s purpose is to build the HTML for a listing of our locations.</p>
<p>The <code class=" language-php">get_locations_output</code> function is by both the location shortcode and the location widget to generate its mark up.  </p>
<p>Since it’s used for multiple purposes, this function has several important actions. I’ll will break them all down step by step. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//main function for displaying locations (used for our shortcodes and widgets)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get_locations_output</span><span class="token punctuation">(</span><span class="token variable">$arguments</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//default args</span>
    <span class="token variable">$default_args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string">'location_id'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'number_of_locations'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//update default args if we passed in new args</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$arguments</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$arguments</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//go through each supplied argument</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$arguments</span> <span class="token keyword">as</span> <span class="token variable">$arg_key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$arg_val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//if this argument exists in our default argument, update its value</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token variable">$arg_key</span><span class="token punctuation">,</span> <span class="token variable">$default_args</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token variable">$default_args</span><span class="token punctuation">[</span><span class="token variable">$arg_key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$arg_val</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//find locations</span>
    <span class="token variable">$location_args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string">'post_type'</span>     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'wp_locations'</span><span class="token punctuation">,</span>
        <span class="token string">'posts_per_page'</span><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$default_args</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'post_status'</span>   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'publish'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//if we passed in a single location to display</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$default_args</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$location_args</span><span class="token punctuation">[</span><span class="token string">'include'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$default_args</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//output</span>
    <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$locations</span> <span class="token operator">=</span> <span class="token function">get_posts</span><span class="token punctuation">(</span><span class="token variable">$location_args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//if we have locations </span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$locations</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;article class="location_list cf"&gt;'</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//foreach location</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$locations</span> <span class="token keyword">as</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;section class="location"&gt;'</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//collect location data</span>
                <span class="token variable">$wp_location_id</span> <span class="token operator">=</span> <span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">;</span>
                <span class="token variable">$wp_location_title</span> <span class="token operator">=</span> <span class="token function">get_the_title</span><span class="token punctuation">(</span><span class="token variable">$wp_location_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$wp_location_thumbnail</span> <span class="token operator">=</span> <span class="token function">get_the_post_thumbnail</span><span class="token punctuation">(</span><span class="token variable">$wp_location_id</span><span class="token punctuation">,</span><span class="token string">'thumbnail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$wp_location_content</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string">'the_content'</span><span class="token punctuation">,</span> <span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">post_content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token variable">$wp_location_content</span> <span class="token operator">=</span> <span class="token function">strip_shortcodes</span><span class="token punctuation">(</span><span class="token function">wp_trim_words</span><span class="token punctuation">(</span><span class="token variable">$wp_location_content</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token variable">$wp_location_permalink</span> <span class="token operator">=</span> <span class="token function">get_permalink</span><span class="token punctuation">(</span><span class="token variable">$wp_location_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$wp_location_phone</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$wp_location_id</span><span class="token punctuation">,</span><span class="token string">'wp_location_phone'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$wp_location_email</span> <span class="token operator">=</span> <span class="token function">get_post_meta</span><span class="token punctuation">(</span><span class="token variable">$wp_location_id</span><span class="token punctuation">,</span><span class="token string">'wp_location_email'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//apply the filter before our main content starts </span>
                <span class="token comment" spellcheck="true">//(lets third parties hook into the HTML output to output data)</span>
                <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string">'wp_location_before_main_content'</span><span class="token punctuation">,</span> <span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//title</span>
                <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;h2 class="title"&gt;'</span><span class="token punctuation">;</span>
                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;a href="'</span> <span class="token punctuation">.</span> <span class="token variable">$wp_location_permalink</span> <span class="token punctuation">.</span> '<span class="token string">" title="</span>view location"<span class="token operator">&gt;</span>'<span class="token punctuation">;</span>
                        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$wp_location_title</span><span class="token punctuation">;</span>
                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/a&gt;'</span><span class="token punctuation">;</span>
                <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/h2&gt;'</span><span class="token punctuation">;</span>


                <span class="token comment" spellcheck="true">//image &amp; content</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_thumbnail</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;p class="image_content"&gt;'</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_thumbnail</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$wp_location_thumbnail</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span>  <span class="token variable">$wp_location_content</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">//phone &amp; email output</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_phone</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_email</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;p class="phone_email"&gt;'</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_phone</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Phone<span class="token punctuation">:</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span><span class="token string">' . $wp_location_phone . '</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>br</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token variable">$wp_location_email</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span></span>Email<span class="token punctuation">:</span> <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span></span>' <span class="token punctuation">.</span> <span class="token variable">$wp_location_email</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/p&gt;'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">//apply the filter after the main content, before it ends </span>
                <span class="token comment" spellcheck="true">//(lets third parties hook into the HTML output to output data)</span>
                <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string">'wp_location_after_main_content'</span><span class="token punctuation">,</span> <span class="token variable">$html</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//readmore</span>
                <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;a class="link" href="'</span> <span class="token punctuation">.</span> <span class="token variable">$wp_location_permalink</span> <span class="token punctuation">.</span> '<span class="token string">" title="</span>view location"<span class="token operator">&gt;</span>View Location<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
            <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/section&gt;'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'&lt;/article&gt;'</span><span class="token punctuation">;</span>
        <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> '<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>cf<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>'<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$html</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>Firstly, the function has an optional argument called <code class=" language-php">arguments</code>. This is used because both the shortcode and the widget will pass options to the display (to customise exactly what will be returned). </li>
<li>The function defines a set of default arguments into the <code class=" language-php"><span class="token variable">$default_args</span></code> array. This will basically set the number of locations to -1 (all locations) and also set the location ID to nothing (meaning we want to display a list of locations, not just one by default).</li>
<li>We check to see if the passed <code class=" language-php"><span class="token variable">$arguments</span></code> variable is not empty and is also an array (meaning we have passed an array of arguments). We go through all of the elements inside the <code class=" language-php"><span class="token variable">$arguments</span></code> array and check to see if any of the array keys matches anything in our <code class=" language-php"><span class="token variable">$default_args</span></code> array. If something matches we update the <code class=" language-php"><span class="token variable">$default_args</span></code> array. </li>
<li>We use the <code class=" language-php"><span class="token variable">$default_args</span></code> array to build a search for <code class=" language-php"><span class="token function">get_posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> which will find all of our locations (if we specified a single location we’ll just search for that) </li>
<li>Now we start building our HTML output. We define our <code class=" language-php"><span class="token variable">$html</span></code> variable and start building our output. </li>
<li>We collect all of our information about the location (title, content, image, link etc) and get it ready for output. </li>
<li>Before we continue collecting our output we all the <code class=" language-php">wp_location_before_main_content</code> filter on our <code class=" language-php"><span class="token variable">$html</span></code> variable. This will let third parties add extra content before the title of the location. This is useful as if we defined any extra fields in our admin we can use this to output them. </li>
<li>The title, image, content, phone and email are added to our output (conditionally checking if they exist).</li>
<li>Before we’re about to output the read more button we call our second filter, the <code class=" language-php">wp_location_after_main_content</code> filter. This will let third parties add content right before the button.</li>
<li>We add our read more button to the output and then return our <code class=" language-php"><span class="token variable">$html</span></code> variable.</li>
</ul>

<p>When we save a single location we want to run a function to collect and update our additional meta information (such as email, phone, address etc).</p>
<p>We use the <code class=" language-php">save_location</code> function for this purpose.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//triggered when adding or editing a location</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">save_location</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//check for nonce</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_nonce_field'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$post_id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    <span class="token comment" spellcheck="true">//verify nonce</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wp_verify_nonce</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_nonce_field'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'wp_location_nonce'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$post_id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//check for autosave</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">defined</span><span class="token punctuation">(</span><span class="token string">'DOING_AUTOSAVE'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token constant">DOING_AUTOSAVE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$post_id</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//get our phone, email and address fields</span>
    <span class="token variable">$wp_location_phone</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_phone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">sanitize_text_field</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_phone'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$wp_location_email</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_email'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">sanitize_text_field</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_email'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token variable">$wp_location_address</span> <span class="token operator">=</span> <span class="token function">isset</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">sanitize_text_field</span><span class="token punctuation">(</span><span class="token global">$_POST</span><span class="token punctuation">[</span><span class="token string">'wp_location_address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//update phone, memil and address fields</span>
    <span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token string">'wp_location_phone'</span><span class="token punctuation">,</span> <span class="token variable">$wp_location_phone</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token string">'wp_location_email'</span><span class="token punctuation">,</span> <span class="token variable">$wp_location_email</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token string">'wp_location_address'</span><span class="token punctuation">,</span> <span class="token variable">$wp_location_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//search for our trading hour data and update</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token global">$_POST</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//if we found our trading hour data, update it</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string">'/^wp_location_trading_hours_/'</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//location save hook </span>
    <span class="token comment" spellcheck="true">//used so you can hook here and save additional post fields added via 'wp_location_meta_data_output_end' or 'wp_location_meta_data_output_end'</span>
    <span class="token function">do_action</span><span class="token punctuation">(</span><span class="token string">'wp_location_admin_save'</span><span class="token punctuation">,</span><span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token global">$_POST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<p>Let’s analyse what we’re doing:</p>
<ul>
<li>We’re firstly checking our nonce and verifying that it exists (passed from the meta box). We also check to make sure we’re not auto-saving. Once we’re sure everything is ok we move on.</li>
<li>We collect the  phone, email and address information and sanitize them with the <a href="https://codex.wordpress.org/Function_Reference/sanitize_text_field"><code class=" language-php"><span class="token function">sanitize_text_field</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> function. They are assigned to variables and then used in our <a href="https://codex.wordpress.org/Function_Reference/update_post_meta"><code class=" language-php"><span class="token function">update_post_meta</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> function to save them to the location. </li>
<li>Because our trading hours are dynamic and we have to collect and save them a little differently. Since we don’t know how many will exist we can’t extract them from the <code class=" language-php"><span class="token global">$_POST</span></code> array by name. So we go through all of the <code class=" language-php"><span class="token global">$_POST</span></code> variables and check to see if any of them start with <code class=" language-php">wp_location_trading_hours_</code>. If they do we update their value and save them as meta information.</li>
<li>Finally, just before we finish we call the <code class=" language-php">wp_location_admin_save</code> action. This action will take current id of the location as <code class=" language-php"><span class="token variable">$post_id</span></code> and let a third party function collect additional information from the global <code class=" language-php"><span class="token global">$_POST</span></code> and save them to the location.</li>
</ul>
<h3 id="loading-our-admin-and-public-scripts-and-styles">Loading Our Admin and Public Scripts and Styles</h3>
<p>We need to load additional CSS files for both the front end and back end of our website. We create two functions that will load any scripts or styles we need. </p>
<p>Inside these CSS files are basic styling for the admin fields inside the meta box and also slight front end styling. </p>
<p>The plugin will work just fine without any CSS so these can be safely omitted if you’re not interested. (If you don’t want to add these, also remember to remove their action call from the construct function). </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//enqueus scripts and stles on the back end</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">enqueue_admin_scripts_and_styles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">wp_enqueue_style</span><span class="token punctuation">(</span><span class="token string">'wp_location_admin_styles'</span><span class="token punctuation">,</span> <span class="token function">plugin_dir_url</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'/css/wp_location_admin_styles.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//enqueues scripts and styled on the front end</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">enqueue_public_scripts_and_styles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">wp_enqueue_style</span><span class="token punctuation">(</span><span class="token string">'wp_location_public_styles'</span><span class="token punctuation">,</span> <span class="token function">plugin_dir_url</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token string">'/css/wp_location_public_styles.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
<h2 id="location-shortcode">Location Shortcode</h2>
<p>Now we can look at the shortcode class that will be used in combination with our main class.</p>
<p>Adding shortcodes gives the admin an easy to use interface to showcase the various locations they might have. These shortcodes will also be customisable, allowing the admin to specify an exact location by its ID or all of them. When you use this shortcode on a page it should look similar to the following</p>
<p><img src="https://dab1nmslvvntp.cloudfront.net/wp-content/uploads/2016/06/1464866457plugin_location_shortcode_output-1024x761.jpg" alt="plugin_location_shortcode_output" width="1024" height="761" class="alignnone size-large wp-image-131854"></p>
<p>We’ll be working inside the <code class=" language-php">wp_location_shortcode<span class="token punctuation">.</span>php</code>file </p>
<h3 id="deny-direct-access">Deny Direct Access</h3>
<p>Just like in our main PHP file we want to deny any direct access. Do add the following to the top of our file</p>
<pre class=" language-php"><code class=" language-php"><span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string">'Nope, not accessing this'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="the-wplocationshortcode-class">The wp_location_shortcode class</h3>
<p>Let’s start by creating the class outline for the shortcode. This class isn’t as large as our main class but it will contain a few functions we’ll look at shortly. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//defines the functionality for the location shortcode</span>
<span class="token keyword">class</span> <span class="token class-name">wp_location_shortcode</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="the-construct-function-1">The _construct function</h3>
<p>We define our construct function and use it to add our actions and filters. This class only needs one function. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//on initialize</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'init'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'register_location_shortcodes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//shortcodes</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="register-the-location-shortcode">Register the Location Shortcode</h3>
<p>We use this function to add our shortcode. </p>
<p>We call the <code class=" language-php">add_shortcode</code> function to create a new shortcode called <code class=" language-php">wp_locations</code>. We then will use the <a href="https://codex.wordpress.org/Function_Reference/add_shortcode"><code class=" language-php">location_shortcode_output</code></a> function to output the shortcode. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//location shortcode</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register_location_shortcodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">add_shortcode</span><span class="token punctuation">(</span><span class="token string">'wp_locations'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'location_shortcode_output'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="building-the-output-for-the-shortcode">Building the Output for the Shortcode</h3>
<p>This function is called from the <code class=" language-php">add_shortcode</code> function and is used to build the output for the shortcode. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//shortcode display</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">location_shortcode_output</span><span class="token punctuation">(</span><span class="token variable">$atts</span><span class="token punctuation">,</span> <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//get the global wp_simple_locations class</span>
    <span class="token keyword">global</span> <span class="token variable">$wp_simple_locations</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//build default arguments</span>
    <span class="token variable">$arguments</span> <span class="token operator">=</span> <span class="token function">shortcode_atts</span><span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string">'location_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">''</span><span class="token punctuation">,</span>
        <span class="token string">'number_of_locations'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span><span class="token variable">$atts</span><span class="token punctuation">,</span><span class="token variable">$tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//uses the main output function of the location class</span>
    <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token variable">$wp_simple_locations</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_locations_output</span><span class="token punctuation">(</span><span class="token variable">$arguments</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$html</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Let’s look at what this function does:</p>
<ul>
<li>The function takes in the arguments of the shortcode <code class=" language-php"><span class="token variable">$atts</span></code>, the content between the shortcode <code class=" language-php"><span class="token variable">$content</span></code> and the name of shortcode <code class=" language-php"><span class="token variable">$tag</span></code>. We use these elements to help build the output</li>
<li>We reference the global <code class=" language-php"><span class="token variable">$wp_simple_locations</span></code> variable so that we’ll have access to the main location class (and all of its functions).</li>
<li>We create a default array of arguments for the shortcode using the <a href="https://codex.wordpress.org/Function_Reference/shortcode_atts"><code class=" language-php"><span class="token function">shortcode_atts</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> function. </li>
<li>We use the <code class=" language-php">get_locations_output</code> function from the <code class=" language-php"><span class="token variable">$wp_simple_locations</span></code> object to build the shortcode output. We pass in our arguments so that the shortcode can provide dynamic content. For example a location ID can be passed so only a single location is returned.</li>
<li>We return the shortcode and it is displayed in whatever page or post you added it to. </li>
</ul>
<h3 id="creating-a-new-wplocationshortcode-object">Creating a New wp_location_shortcode Object</h3>
<p>At the end of your class you will create a new <code class=" language-php">wp_location_shortcode</code>object.  All of the functionality inside of the class will be activated and you will be able to use your new shortcode.</p>
<pre class=" language-php"><code class=" language-php"><span class="token variable">$wp_location_shortcode</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">wp_location_shortcode</span><span class="token punctuation">;</span>
</code></pre>

<p>Let’s wrap this up by looking at the class that handles the functionality for the location widget.</p>
<p>We add widget support because almost all themes support widgets and they give the admin user a quick and simple way to showcase their locations (or perhaps a single location).</p>
<p>We open the <code class=" language-php">wp_location_widget<span class="token punctuation">.</span>php</code> file and begin.</p>
<h3 id="deny-direct-access-1">Deny Direct Access</h3>
<p>Again we deny direct access to the PHP file by including the following at the very beginning:</p>
<pre class=" language-php"><code class=" language-php"><span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string">'Nope, not accessing this'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="the-wplocationwidget-class">The wp_location_widget Class</h3>
<p>Let’s create our basic structure for the <code class=" language-php">wp_location_widget</code> class. </p>
<p>The class is similar to our other classes we have created; however this time we’re extending the already defined <a href="https://codex.wordpress.org/Widgets_API"><code class=" language-php">WP_widget</code></a> class.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//main widget used for displaying locations</span>
<span class="token keyword">class</span> <span class="token class-name">wp_location_widget</span> <span class="token keyword">extends</span> <span class="token class-name">WP_widget</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="the-construct-function-2">The _construct Function</h3>
<p>Inside our <code class=" language-php">_construct</code> function we define the basic properties of our widget by overloading the parent <code class=" language-php">_construct</code> function and supplying our own values. We set the ID, name and description of the widget. </p>
<p>In addition, we also hook our <code class=" language-php">register_wp_location_widgets</code> function onto the <code class=" language-php">widgets_init</code> hook so that we can register our widget.</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//initialise widget values</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//set base values for the widget (override parent)</span>
    <span class="token scope"><span class="token keyword">parent</span><span class="token punctuation">::</span></span><span class="token function">__construct</span><span class="token punctuation">(</span>
        <span class="token string">'wp_location_widget'</span><span class="token punctuation">,</span>
        <span class="token string">'WP Location Widget'</span><span class="token punctuation">,</span> 
        <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string">'description'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'A widget that displays your locations'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string">'widgets_init'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token this">$this</span><span class="token punctuation">,</span><span class="token string">'register_wp_location_widgets'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>The admin interface is what the admin user will interact with when setting up the widget. </p>
<p>Because we want to offer some options, you can choose how many locations will be shown via the widget and also if you want to select a single location to display. </p>
<p>The function <code class=" language-php"><span class="token function">form</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> is inherited from the parent <code class=" language-php">WP_widget</code> so it will be automatically called when we’re on the widget admin screen.</p>
<pre class=" language-php"><code class=" language-php">    <span class="token comment" spellcheck="true">//handles the back-end admin of the widget</span>
    <span class="token comment" spellcheck="true">//$instance - saved values for the form</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span><span class="token variable">$instance</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//collect variables </span>
        <span class="token variable">$location_id</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$number_of_locations</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">isset</span><span class="token punctuation">(</span><span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token delimiter">?&gt;</span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span></span>Select your options below<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_name</span><span class="token punctuation">(</span><span class="token string">'location_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>Location to display<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>widefat<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_name</span><span class="token punctuation">(</span><span class="token string">'location_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_id</span><span class="token punctuation">(</span><span class="token string">'location_id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$location_id</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>All Locations<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token php"><span class="token delimiter">&lt;?php</span>
                <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
                    <span class="token string">'posts_per_page'</span>    <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string">'post_type'</span>         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'wp_locations'</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token variable">$locations</span> <span class="token operator">=</span> <span class="token function">get_posts</span><span class="token punctuation">(</span><span class="token variable">$args</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$locations</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$locations</span> <span class="token keyword">as</span> <span class="token variable">$location</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span> <span class="token operator">==</span> <span class="token variable">$location_id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            <span class="token keyword">echo</span> <span class="token string">'&lt;option selected value="'</span> <span class="token punctuation">.</span> <span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">ID</span> <span class="token punctuation">.</span> <span class="token string">'"&gt;'</span> <span class="token punctuation">.</span> <span class="token function">get_the_title</span><span class="token punctuation">(</span><span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/option&gt;'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                            <span class="token keyword">echo</span> <span class="token string">'&lt;option value="'</span> <span class="token punctuation">.</span> <span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">ID</span> <span class="token punctuation">.</span> <span class="token string">'"&gt;'</span> <span class="token punctuation">.</span> <span class="token function">get_the_title</span><span class="token punctuation">(</span><span class="token variable">$location</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">ID</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token string">'&lt;/option&gt;'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token delimiter">?&gt;</span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>small</span><span class="token punctuation">&gt;</span></span></span><span class="token keyword">If</span> you want to display multiple locations select how many below<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>small</span><span class="token punctuation">&gt;</span></span></span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_id</span><span class="token punctuation">(</span><span class="token string">'number_of_locations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>Number of Locations<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>widefat<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_name</span><span class="token punctuation">(</span><span class="token string">'number_of_locations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token this">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_field_id</span><span class="token punctuation">(</span><span class="token string">'number_of_locations'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$number_of_locations</span><span class="token punctuation">;</span> <span class="token delimiter">?&gt;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span>All Locations<span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">1</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">2</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">3</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>4<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">4</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'5'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">5</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
                <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php"><span class="token delimiter">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$number_of_locations</span> <span class="token operator">==</span> <span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">echo</span> <span class="token string">'selected'</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token delimiter">?&gt;</span></span></span><span class="token punctuation">&gt;</span></span></span><span class="token number">10</span><span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span></span>
            <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span></span>
        <span class="token delimiter">&lt;?php</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>Let’s go through what’s happening here:</p>
<ul>
<li>First we’re defining values for our location ID and the number of locations. We check to see if the <code class=" language-php"><span class="token variable">$instance</span></code> variable holds any of these values (if they already exist). If the values do exist we extract them, if they do not we simple supply default values (setting number of locations to 5 and the location ID to default).</li>
<li>We create a label and form field that will be used to display the locations to the admin. We fetch all of the locations with <a href="https://codex.wordpress.org/Template_Tags/get_posts"><code class=" language-php"><span class="token function">get_posts</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> and display them. We check against each location to see if it matches the value saved in the location id (if it has been set).</li>
<li>We create the select list for the number of locations to display. Again we check each option to see if it matches a value passed into the number of locations variable.</li>
</ul>

<p>The widget needs to call an update function to save its form values and that is what this function does.</p>
<p>The <code class=" language-php"><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function is again inherited from the parent <code class=" language-php">WP_widget</code> class so we just specify how we’re going to save our values</p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//handles updating the widget </span>
<span class="token comment" spellcheck="true">//$new_instance - new values, $old_instance - old saved values</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token variable">$new_instance</span><span class="token punctuation">,</span> <span class="token variable">$old_instance</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$new_instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$new_instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We’re given two variables, the <code class=" language-php"><span class="token variable">$new_instance</span></code> and the <code class=" language-php"><span class="token variable">$old_instance</span></code>.</p>
<p>The new instance contains our current values in the form and the old instance contains our previous values. </p>
<p>What we do is create a new array to hold our extracted values and then return them. </p>

<p>The <code class=" language-php"><span class="token function">widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function is another function inherited from the parent <code class=" language-php">WP_widget</code> class and is responsible for the output of the widget for the front end. It leverages the display function from the <code class=" language-php">wp_simple_locations</code> class to build its output. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//handles public display of the widget</span>
<span class="token comment" spellcheck="true">//$args - arguments set by the widget area, $instance - saved values</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">widget</span><span class="token punctuation">(</span> <span class="token variable">$args</span><span class="token punctuation">,</span> <span class="token variable">$instance</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//get wp_simple_location class (as it builds out output)</span>
    <span class="token keyword">global</span> <span class="token variable">$wp_simple_locations</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//pass any arguments if we have any from the widget</span>
    <span class="token variable">$arguments</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//if we specify a location</span>

    <span class="token comment" spellcheck="true">//if we specify a single location</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$arguments</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'location_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//if we specify a number of locations</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$arguments</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string">'number_of_locations'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//get the output</span>
    <span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string">'before_widget'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string">'before_title'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token string">'Locations'</span><span class="token punctuation">;</span>
    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string">'after_title'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//uses the main output function of the location class</span>
    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$wp_simple_locations</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get_locations_output</span><span class="token punctuation">(</span><span class="token variable">$arguments</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$html</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token variable">$args</span><span class="token punctuation">[</span><span class="token string">'after_widget'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">echo</span> <span class="token variable">$html</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Let’s go through what we have done:</p>
<ul>
<li>We collect our global <code class=" language-php"><span class="token variable">$wp_simple_locations</span></code>object as we want to use its display function.</li>
<li>We create a blank array of arguments and then check to see if our widget specified any arguments (such as the number of locations to display or a single specific location).</li>
<li>We start our build process for the output and define our <code class=" language-php"><span class="token variable">$html</span></code> variable. We call the <code class=" language-php"><span class="token function">get_locations_output</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code> function defined in the <code class=" language-php"><span class="token variable">$wp_simple_locations</span></code>object and pass in our arguments (it will return all of the HTML we need).</li>
<li>We echo the result of our <code class=" language-php"><span class="token variable">$html</span></code> variable and the widget is displayed.</li>
</ul>

<p>We use this function to register our widget with WordPress. We do this by calling the <a href="https://codex.wordpress.org/Function_Reference/register_widget"><code class=" language-php"><span class="token function">register_widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></a> function and supplying the name of our class as the value into the function. </p>
<pre class=" language-php"><code class=" language-php"><span class="token comment" spellcheck="true">//registers our widget for use</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">register_wp_location_widgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">register_widget</span><span class="token punctuation">(</span><span class="token string">'wp_location_widget'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I hope you’ve enjoyed this real world example of building a WordPress plugin from scratch, stay tuned for more.</p>
  