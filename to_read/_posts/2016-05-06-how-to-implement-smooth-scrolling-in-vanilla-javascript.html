---
title: "How to Implement Smooth Scrolling in Vanilla JavaScript"
description: "Forget jQuery plugins, Giulio Mainardi shows how do smooth scrolling in vanilla JavaScript, and refactors an ES6 library to ES5."
link: "http://www.sitepoint.com/smooth-scrolling-vanilla-javascript/"
saved: "2016-05-06 17:18:04"
---

    <p><em>This article was peer reviewed by <a href="http://www.sitepoint.com/author/asandu/">Adrian Sandu</a>, <a href="http://www.sitepoint.com/author/cperry/">Chris Perry</a>, <a href="http://www.sitepoint.com/author/jheleine/">Jérémy Heleine</a> and Mallory van Achterberg. Thanks to all of SitePoint’s peer reviewers for making SitePoint content the best it can be!</em></p>
<p>Smooth scrolling is a user interface pattern that progressively enhances the default in-page navigation experience, animating the change of position within the scroll box (the viewport, or a scrollable element) from the location of the activated link to the location of the destination element indicated in the hash fragment of the link URL.</p>

<p>This is nothing new, being a pattern known from many years now, check for instance this <a href="http://www.sitepoint.com/scroll-smoothly-javascript/">SitePoint article</a> that dates back to 2003!  As an aside, this article has a historical value as it shows how client-side JavaScript programming, and the DOM in particular, has changed and evolved over the years, allowing the development of less cumbersome vanilla JavaScript solutions.</p>
<p>There are many implementations of this pattern within the jQuery ecosystem, either using jQuery directly or implemented with a plugin, but in this article we are interested in a pure JavaScript solution. Specifically, we are going to explore and leverage the <a href="http://callmecavs.com/jump.js/">Jump.js</a> library.</p>
<p>After a presentation of the library, with an overview of its features and characteristics, we will apply some changes to the original code to adapt it to our needs. In doing this, we will refresh some core JavaScript language skills such as functions and closures. We will then create a HTML page to test the smooth scrolling behavior that it will be then implemented as a custom script. Support, when available, for native smooth scrolling with CSS will then be added and finally we will conclude with some observations concerning the browser navigation history.</p>
<p>Here is a is the final demo that we’ll be creating:</p>
<p data-height="364" data-theme-id="6441" data-slug-hash="YqewzZ" data-default-tab="result" data-user="SitePoint" class="codepen">See the Pen <a href="http://codepen.io/SitePoint/pen/YqewzZ/">Smooth Scrolling</a> by SitePoint (<a href="http://codepen.io/SitePoint">@SitePoint</a>) on <a href="http://codepen.io/">CodePen</a>.</p>
<p></p>
<p>The <a href="https://github.com/sitepoint-editors/smooth-scrolling">full source code</a> is available on GitHub.</p>
<h2 id="jumpjs">Jump.js</h2>
<p>Jump.js is written in vanilla ES6 JavaScript, without any external dependencies. It is a small utility, being only about 42 <a href="https://en.wikipedia.org/wiki/Source_lines_of_code">SLOC</a>, but the size of the provided minified bundle is around 2.67 KB because it has to be transpiled. A <a href="http://callmecavs.com/jump.js/">Demo</a> is available on the GitHub project page. </p>
<p>As suggested by the library name,  it provides only the jump: the animated change of the scrollbar position from its current value to the destination, specified by providing either a DOM element, a CSS selector, or a distance in the form of a positive or negative number value. This means that in the implementation of the smooth scrolling pattern, we must perform the link hijacking ourselves. More on this in the following sections.</p>
<p>Note that currently <a href="https://github.com/callmecavs/jump.js/issues/23">only the scrolling of the viewport is supported</a> and only vertically. </p>
<p>We can configure a jump with some options such as the duration (this parameter is mandatory), the easing function, and a callback to be fired at the end of the animation. We will see them in action later in the demo. See the <a href="https://github.com/callmecavs/jump.js">documentation</a> for full details.</p>
<p>Jump.js runs without problems on ‘modern’ browsers, including Internet Explorer version 10 or higher. Again, refer to the <a href="https://github.com/callmecavs/jump.js#browser-support">documentation</a> for the full list of supported browsers. With a suitable <a href="https://github.com/chrisdickinson/raf">polyfill for requestAnimationFrame</a> it should run even on older browsers. </p>
<h2 id="aquickpeekbehindthescreen">A Quick Peek Behind the Screen</h2>
<p>Internally the Jump.js source uses the <a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame">requestAnimationFrame</a> method of the window object to schedule the update of the position of the viewport vertical position at each frame of the scrolling animation. This update is achieved passing the next position value computed with the easing function to the <code class=" language-undefined">window.scrollTo</code> method. See the <a href="https://github.com/callmecavs/jump.js/blob/master/src/jump.js">source</a> for full details.</p>
<h2 id="abitofcustomization">A Bit of Customization</h2>
<p>Before diving into a demo to show the usage of Jump.js, we are going to make some slight changes to the original code, that will however leave its inner workings unmodified.</p>
<p>The source code is written in ES6 and needs to be used with a JavaScript build tool for transpiling and bundling modules. This could be overkill for some projects, so we are going to apply some refactoring to convert the code to ES5, ready to be used everywhere.</p>
<p>First things first, let’s remove the ES6 syntax and features. The script defines an <a href="http://www.sitepoint.com/object-oriented-javascript-deep-dive-es6-classes/">ES6 class</a>:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">import</span> easeInOutQuad <span class="token keyword">from</span> <span class="token string">'./easing'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Jump</span> <span class="token punctuation">{</span>
  <span class="token function">jump</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> window<span class="token punctuation">.</span>pageYOffset

    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
      duration<span class="token punctuation">:</span> options<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
      offset<span class="token punctuation">:</span> options<span class="token punctuation">.</span>offset <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      callback<span class="token punctuation">:</span> options<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
      easing<span class="token punctuation">:</span> options<span class="token punctuation">.</span>easing <span class="token operator">||</span> easeInOutQuad
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'string'</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>offset <span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top
      <span class="token punctuation">:</span> target

    <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>duration <span class="token operator">===</span> <span class="token string">'function'</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">duration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>duration

    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>time <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart <span class="token operator">=</span> time
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed <span class="token operator">=</span> time <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart
    <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration<span class="token punctuation">)</span>

    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration
      <span class="token operator">?</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>time <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">)</span>

    <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We could convert this to a ES5 ‘class’ with a constructor function and a bunch of prototype methods, but observe that we never need multiple instances of this class, so a singleton implemented with a plain object literal will do the trick:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">var</span> jump <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>

        jump<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> window<span class="token punctuation">.</span>pageYOffset

            <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token punctuation">{</span>
              duration<span class="token punctuation">:</span> options<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
              offset<span class="token punctuation">:</span> options<span class="token punctuation">.</span>offset <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
              callback<span class="token punctuation">:</span> options<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
              easing<span class="token punctuation">:</span> options<span class="token punctuation">.</span>easing <span class="token operator">||</span> easeInOutQuad
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>distance <span class="token operator">=</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'string'</span>
              <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>offset <span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top
              <span class="token punctuation">:</span> target

            <span class="token keyword">this</span><span class="token punctuation">.</span>duration <span class="token operator">=</span> <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>duration <span class="token operator">===</span> <span class="token string">'function'</span>
              <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">duration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
              <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>duration

            <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>_loop<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        _loop<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart <span class="token operator">=</span> time
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed <span class="token operator">=</span> time <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart
            <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration<span class="token punctuation">)</span>

            window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>next<span class="token punctuation">)</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>timeElapsed <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>duration
              <span class="token operator">?</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>_loop<span class="token punctuation">)</span>
              <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        _end<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>distance<span class="token punctuation">)</span>

            <span class="token keyword">typeof</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timeStart <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> _loop <span class="token operator">=</span> o<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Robert Penner's easeInOutQuad - http://robertpenner.com/easing/</span>
    <span class="token keyword">function</span> <span class="token function">easeInOutQuad</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        t <span class="token operator">/</span><span class="token operator">=</span> d <span class="token operator">/</span> <span class="token number">2</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> c <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> t <span class="token operator">*</span> t <span class="token operator">+</span> b
        t<span class="token operator">--</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>c <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">*</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> b
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> o<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Apart from removing the class, we needed to make a couple of other changes. The callback for <code class=" language-undefined">requestAnimationFrame</code>, used to update the scrollbar position at each frame, which in the original code is invoked through an ES6 <a href="http://www.sitepoint.com/es6-arrow-functions-new-fat-concise-syntax-javascript">arrow function</a>, is pre-bound to the jump singleton at init time. Then we bundle the default easing function in the same source file. Finally, we have wrapped the code in an IIFE(<a href="http://www.sitepoint.com/demystifying-javascript-closures-callbacks-iifes/">Immediately-invoked Function Expressions</a>) to avoid namespace pollution.</p>
<p>Now we can apply another refactoring step, noting that with the help of <a href="http://www.sitepoint.com/demystifying-javascript-closures-callbacks-iifes/">nested functions and closures</a> we can just use a function instead of an object:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">jump</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> start <span class="token operator">=</span> window<span class="token punctuation">.</span>pageYOffset<span class="token punctuation">;</span>

    <span class="token keyword">var</span> opt <span class="token operator">=</span> <span class="token punctuation">{</span>
      duration<span class="token punctuation">:</span> options<span class="token punctuation">.</span>duration<span class="token punctuation">,</span>
      offset<span class="token punctuation">:</span> options<span class="token punctuation">.</span>offset <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
      callback<span class="token punctuation">:</span> options<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
      easing<span class="token punctuation">:</span> options<span class="token punctuation">.</span>easing <span class="token operator">||</span> easeInOutQuad
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> distance <span class="token operator">=</span> <span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">?</span> 
        opt<span class="token punctuation">.</span>offset <span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token punctuation">:</span> 
        target
    <span class="token punctuation">;</span>

    <span class="token keyword">var</span> duration <span class="token operator">=</span> <span class="token keyword">typeof</span> opt<span class="token punctuation">.</span>duration <span class="token operator">===</span> <span class="token string">'function'</span>
          <span class="token operator">?</span> opt<span class="token punctuation">.</span><span class="token function">duration</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
          <span class="token punctuation">:</span> opt<span class="token punctuation">.</span>duration
    <span class="token punctuation">;</span>

    <span class="token keyword">var</span> 
        timeStart <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        timeElapsed
    <span class="token punctuation">;</span>

    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeStart <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            timeStart <span class="token operator">=</span> time<span class="token punctuation">;</span>

        timeElapsed <span class="token operator">=</span> time <span class="token operator">-</span> timeStart<span class="token punctuation">;</span>

        window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> start<span class="token punctuation">,</span> distance<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">&lt;</span> duration<span class="token punctuation">)</span>
            <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
        <span class="token keyword">else</span>
            <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> start <span class="token operator">+</span> distance<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">typeof</span> opt<span class="token punctuation">.</span>callback <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> opt<span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        timeStart <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ...</span>

<span class="token punctuation">}</span>
</code></pre>
<p>The singleton now becomes the <code class=" language-undefined">jump</code> function that will be called to animate the scroll, and the <code class=" language-undefined">loop</code> and <code class=" language-undefined">end</code> callbacks become nested functions, while the object’s properties now become local variables (closures). We don’t need the IIFE anymore, because now all the code is safely wrapped in the one function.</p>
<p>As a last refactoring step, to avoid repeating the <code class=" language-undefined">timeStart</code> reset check at each invocation of the loop callback, the first time <code class=" language-undefined">requestAnimationFrame()</code> is called we pass it an anonymous function that resets the <code class=" language-undefined">timerStart</code> variable before calling the loop function:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span> timeStart <span class="token operator">=</span> time<span class="token punctuation">;</span> <span class="token function">loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loop</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timeElapsed <span class="token operator">=</span> time <span class="token operator">-</span> timeStart<span class="token punctuation">;</span>

    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> opt<span class="token punctuation">.</span><span class="token function">easing</span><span class="token punctuation">(</span>timeElapsed<span class="token punctuation">,</span> start<span class="token punctuation">,</span> distance<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">&lt;</span> duration<span class="token punctuation">)</span>
        <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
    <span class="token keyword">else</span>
        <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Once again note that in the course of refactoring, the core scrolling animation code didn’t change.</p>
<h2 id="thetestpage">The Test Page</h2>
<p>Now that we have customized the script to suit our needs, we are ready to assemble a testing demo. In this section we’ll write the page that will be enhanced with smooth scrolling, using the script presented in the next section.</p>
<p>The page consists of a table of contents (TOC) with in-page links to following sections in the document, and with additional links back to the TOC. We will mix-in some external links pointing to other pages too. Here’s the basic structure of this page:</p>
<pre class=" language-markup"><code class="markup  language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toc<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#sect-1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Section 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#sect-2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Section 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            ...
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sect-1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Section 1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Pellentesque habitant morbi tristique senectus et netus et <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.example.net/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>a link to another page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> ac turpis egestas. <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.example.net/index.html#foo<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>A link to another page, with an anchor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span> quam, feugiat vitae, ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#toc<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Back to TOC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sect-2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Section 2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>section</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>jump.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>script.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>In the head, we’ll include a few CSS rule to setup a basic, minimal layout, while at the end of the body tag we include two JavaScript files: the former is our refactored version of Jump.js and the latter is the script that we will now discuss.</p>
<h2 id="themasterscript">The Master Script</h2>
<p>This is the script that will enhance the scrolling experience of the test page with the animated jumps provided by our custom version of the Jump.js library. Of course, this code will also be written in ES5 JavaScript.</p>
<p>Let’s briefly outline the tasks the it should accomplish: It must <em>hijack</em> clicks on in-page links, disabling the browser’s default behavior (the abrupt jump to the target element, indicated in the hash fragment of the href attribute of the clicked link), and replace it with a call to our jump() function.</p>
<p>So, first thing is to monitor the clicks on the in-page links. We can do this in two ways, with event delegation or attaching the handler to each relevant link.</p>
<h3 id="eventdelegation">Event Delegation</h3>
<p>In the first approach we add our click listener to only one element, <code class=" language-undefined">document.body</code>. In this way, every click event on any element of the page will bubble up the DOM tree along the branch of its ancestors until it reaches <code class=" language-undefined">document.body</code>:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript">document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> onClick<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Of course, now in the registered event listener(<code class=" language-undefined">onClick</code>) we have to inspect the target of the incoming click event object to check that it is related to an in-page link element. This can be done in several ways, so we abstract it to a helper function,  <code class=" language-undefined">isInPageLink()</code>. We’ll have a look at the mechanics of this function in a moment.</p>
<p>If the incoming click is on an in-page link, we stop the event bubbling and prevent the associated default action. Finally we call the jump function, providing it with the hash selector for the target element and the parameters to configure the desired animation.</p>
<p>Here’s the event handler:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInPageLink</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">jump</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        duration<span class="token punctuation">:</span> duration
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="individualhandlers">Individual Handlers</h3>
<p>With the second approach to monitoring the link clicks, a slight modified version of the event handler presented above is attached to each in-page link element, so there is no event bubbling:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>isInPageLink<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> onClick<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>We query for all <code class=" language-undefined">&lt;a&gt;</code> elements, and convert the returned DOM <code class=" language-undefined">NodeList</code> to a JavaScript array with the <a href="https://toddmotto.com/ditch-the-array-foreach-call-nodelist-hack/">[].slice() hack</a> (If the target browsers support it, a better alternative would be to use the ES6 <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Array/from">Array.from()</a> method). Then we can use the array methods to filter the in-page links,  re-using the same helper function defined above, and finally attach the listener to the remaining link elements.</p>
<p>The event handler is almost the same as before but of course we don’t need to check the click target:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">jump</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        duration<span class="token punctuation">:</span> duration
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Which approach is best depends on the use context. For example, if new links elements may be dynamically added after the initial page load, then we must use event delegation.</p>
<p>Now we turn to the implementation of  <code class=" language-undefined">isInPageLink()</code>, the helper function we used in the previous event handlers to abstract the test for the in-page links.  As we have seen, this function takes a DOM node as an argument and returns a boolean value to indicate if the node represents an in-page link element. It is not sufficient to check that the passed node is an A tag and that it has an hash fragment set, because the link could be to another page and in this case the default browser action must not disabled. So we check if the value stored in the attribute href ‘minus’ the hash fragment is equal to the page URL:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">isInPageLink</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n<span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'a'</span> 
        <span class="token operator">&amp;&amp;</span> n<span class="token punctuation">.</span>hash<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span>
        <span class="token operator">&amp;&amp;</span> <span class="token function">stripHash</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>href<span class="token punctuation">)</span> <span class="token operator">===</span> pageUrl
    <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code class=" language-undefined">stripHash()</code> is another helper function that we also use to set the value of the variable <code class=" language-undefined">pageUrl</code> when the script is initialized:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">var</span> pageUrl <span class="token operator">=</span> location<span class="token punctuation">.</span>hash
        <span class="token operator">?</span> <span class="token function">stripHash</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> location<span class="token punctuation">.</span>href
    <span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">stripHash</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This string-based solution with the trimming of the hash fragment works even with URLs with query strings because the hash part comes after them in the general structure of an URL.</p>
<p>As I said before, this is only one possible way to implement this test. For example, the article cited at the beginning of this tutorial uses a different solution, making a component-wise comparison of the link href with the <code class=" language-undefined">location</code> object.</p>
<p>It should be noted that we have used this function in both approaches to event subscription, but in the second one we are using it as a filter for elements that we already know are <code class=" language-undefined">&lt;a&gt;</code> tags so the first check on the <code class=" language-undefined">tagName</code> attribute is redundant. This is left as an exercise for the reader.</p>
<h3 id="accessibilityconsiderations">Accessibility Considerations</h3>
<p>As it stands, our code is vulnerable to a known bug (actually a pair of unrelated bugs hitting Blink/WebKit/KHTML and one hitting IE) which affects keyboard users. When tabbing through the TOC links, activating one will smoothly scroll down to the selected section, but the focus will remain on the link. This means that on the next tab key press the user will be sent back up to the TOC, rather than to the first link within their chosen section.</p>
<p>To fix this, we’re going to add another function to our master script:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token comment" spellcheck="true">// Adapted from:</span>
<span class="token comment" spellcheck="true">// https://www.nczonline.net/blog/2013/01/15/fixing-skip-to-content-links/</span>
<span class="token keyword">function</span> <span class="token function">setFocus</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex">/^(?:a|select|input|button|textarea)$/i</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            element<span class="token punctuation">.</span>tabIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>which will be run in a callback that we’ll pass to the <code class=" language-undefined">jump</code> function, passing the hash value of the element we’re scrolling to:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token function">jump</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    duration<span class="token punctuation">:</span> duration<span class="token punctuation">,</span>
    callback<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setFocus</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>What this function does is fetch the DOM element that the hash value corresponds to, and test to see if it’s already an element that can receive the focus (e.g. an anchor or a button element). If the element <em>cannot</em> receive the focus by default (like our <code class=" language-undefined">&lt;section&gt;</code> containers), it then sets its <code class=" language-undefined">tabIndex</code> attribute to <code class=" language-undefined">-1</code> (allowing it to receive the focus programmatically, but not via keyboard). The focus is then set to that element, meaning that the user’s next <kbd>tab</kbd> press will move the focus to the next available link.</p>
<p>You can view the complete source of the master script, with all the previously discussed changes, <a href="https://github.com/sitepoint-editors/smooth-scrolling/blob/gh-pages/script.js">here</a>.</p>
<h2 id="supportingnativesmoothscrollingwithcss">Supporting Native Smooth Scrolling  with CSS</h2>
<p>The <a href="https://drafts.csswg.org/cssom-view/#smooth-scrolling">CSS Object Model View module specification</a> introduces a new property to natively implement smooth scrolling: <code class=" language-undefined">scroll-behavior</code>. </p>
<p>It can take two values, <code class=" language-undefined">auto</code> for the default instant scrolling and <code class=" language-undefined">smooth</code> for the animated scrolling.<br>
The specification doesn’t provide any way to configure the animation of the scroll, such as its duration and the timing function (easing).</p>
<p class="ciu_embed" data-feature="css-scroll-behavior" data-periods="future_1,current,past_1,past_2"><iframe src="http://caniuse.bitsofco.de/embed/index.html?feat=css-scroll-behavior&amp;periods=future_1,current,past_1,past_2" frameborder="0" width="100%" height="436px"></iframe></p>
<p></p>
<p>Unfortunately, at the time of writing the support is very limited. In Chrome this feature is <a href="https://www.chromestatus.com/features/5812155903377408">under development</a> and a partial implementation is available by enabling it in the <code class=" language-undefined">chrome://flags</code> screen. The CSS property is is not implemented yet so the smooth scrolling on link clicks doesn’t work.</p>
<p>Anyway, with a tiny change to our master script, we can detect if this feature is available in the user agent and avoid running the rest of our code. To use smooth scrolling on the viewport we apply the CSS property to the root element, HTML (but in our test page we could even apply it to the body element):</p>
<pre class=" language-css"><code class="css  language-css"><span class="token selector">html </span><span class="token punctuation">{</span>
    <span class="token property">scroll-behavior</span><span class="token punctuation">:</span> smooth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then we add a simple feature-detection test at the beginning of the script:</p>
<pre class=" language-javascript"><code class="javascript  language-javascript"><span class="token keyword">function</span> <span class="token function">initSmoothScrolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCssSmoothSCrollSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'css-support-msg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'supported'</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isCssSmoothSCrollSupported</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'scrollBehavior'</span> <span class="token keyword">in</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>style<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Hence, if the browser supports the native scrolling the script does nothing and quits, otherwise it will continue the execution as before and the unsupported CSS property will be ignored by the browser.</p>
<h2 id="conclusion">Conclusion</h2>
<p>A further advantage of the CSS solution just discussed, beyond implementation simplicity and performance, is that the browser history behavior is consistent with what you experience when using the browser’s default scrolling. Every in-page jump is pushed on the browser history stack and we can go back-and-forth through these with the respective buttons (but without smooth scrolling, at least in Firefox).</p>
<p>In the code we wrote (that we could now consider as a fallback for when the CSS support is not available) we did not take into consideration the behavior of the script with respect to the browser history. Depending on the context and use-case, this is something that may or may not be of interest, but if we are taking the view that the script should enhance the default scrolling experience we should expect consistent behavior, as it happens with CSS.</p>
  