---
title: "requestAnimationFrame Scheduling For Nerds — Medium"
description: "A few people were curious about the scheduling of requestAnimationFrame callbacks, so here’s the tl;dr:"
link: "https://medium.com/@paul_irish/requestanimationframe-scheduling-for-nerds-9c57f7438ef4#.m8huxi787"
saved: "2016-07-12 20:44:57"
---
<section name="86e5" class=" section--body section--first"><div class="section-divider layoutSingleColumn"><hr class="section-divider"></div><div class="section-content"><div class="section-inner layoutSingleColumn"><h3 name="bfde" id="bfde" class="graf--h3 graf--leading">requestAnimationFrame Scheduling For Nerds</h3><p name="bc5b" id="bc5b" class="graf--p graf-after--h3">A few people were curious about the scheduling of requestAnimationFrame callbacks, so here’s the tl;dr:</p><h4 name="1e40" id="1e40" class="graf--h4 graf-after--p">All rAF callbacks always run in the same or next frame of work</h4><p name="f827" id="f827" class="graf--p graf-after--h4">Any rAFs queued in your event handlers will be executed in the ​<em class="markup--em markup--p-em">same frame</em>​.<br>Any rAFs queued in a rAF will be executed in the <em class="markup--em markup--p-em">next frame​</em>.</p><p name="579d" id="579d" class="graf--p graf-after--p">All rAFs that are queued <em class="markup--em markup--p-em">will</em> be executed in the intended frame.</p><p name="fd28" id="fd28" class="graf--p graf-after--p">Let’s say there’s 5 callbacks queued up, and they’ll each take ~100 ms. The browser <em class="markup--em markup--p-em">will not </em>distribute them amongst many frames. It’ll try to run them all in the intended frame, even if it takes 500 ms. That means a pretty significant jank.</p><p name="0b53" id="0b53" class="graf--p graf-after--p"><em class="markup--em markup--p-em">You may be asking, “why would there be FIVE animationFrame callbacks requested from within a single frame?” It can accidentally happen if you do 2 very reasonable things. 1) You request a new callback at the end of a rAF. 2) You request rAF callbacks from a input handlers. As a result, you’ve doubled/tripled your work each frame. Youch.</em></p><h4 name="a471" id="a471" class="graf--h4 graf-after--p">Every rAF you request <strong class="markup--strong markup--h4-strong">will</strong> run</h4><p name="ca54" id="ca54" class="graf--p graf-after--h4">rAFs aren’t throttled for you if they take too long to execute.</p><p name="834e" id="834e" class="graf--p graf-after--p">It’s up to you to coalesce rAFs on your own. So: if there’s a chance of multiple of the “same” callbacks firing within the same frame, then you must manage the scheduling/coalescing.</p><p name="50f9" id="50f9" class="graf--p graf-after--p graf--last">That said, Chrome (at least) will try to help some. If rAFs are hogging the main thread, the browser will start to throttle input events so that, hopefully, the contention will clear up.</p></div></div></section><section name="5e2f" class=" section--body section--last"><div class="section-divider layoutSingleColumn"><hr class="section-divider"></div><div class="section-content"><div class="section-inner layoutSingleColumn"><p name="4055" id="4055" class="graf--p graf--leading"><em class="markup--em markup--p-em">And now this.. T</em>wo diagrams that (while only slightly related) may illustrate the lifecycle of events in a frame:</p><figure name="1391" id="1391" class="graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill"></div><div class="progressiveMedia js-progressiveMedia graf-image is-canvasLoaded is-imageLoaded" data-image-id="1*3El5z3z2lVM--Rr1RkzqNA.png" data-width="1008" data-height="342" data-action="zoom" data-action-value="1*3El5z3z2lVM--Rr1RkzqNA.png" data-scroll="native"><img src="https://cdn-images-2.medium.com/freeze/max/30/1*3El5z3z2lVM--Rr1RkzqNA.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-2.medium.com/max/800/1*3El5z3z2lVM--Rr1RkzqNA.png" src="https://cdn-images-2.medium.com/max/800/1*3El5z3z2lVM--Rr1RkzqNA.png"><noscript class="js-progressiveMedia-inner">&lt;img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-2.medium.com/max/800/1*3El5z3z2lVM--Rr1RkzqNA.png"&gt;</noscript></div></div><figcaption class="imageCaption">Life of a frame (main thread edition)</figcaption></figure><figure name="dd89" id="dd89" class="graf--figure graf-after--figure"><div class="aspectRatioPlaceholder is-locked"><div class="aspectRatioPlaceholder-fill"></div><div class="progressiveMedia js-progressiveMedia graf-image is-canvasLoaded is-imageLoaded" data-image-id="1*atEwskfs0gtIryRrgnAPkw.png" data-width="824" data-height="355" data-action="zoom" data-action-value="1*atEwskfs0gtIryRrgnAPkw.png" data-scroll="native"><img src="https://cdn-images-2.medium.com/freeze/max/30/1*atEwskfs0gtIryRrgnAPkw.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-2.medium.com/max/800/1*atEwskfs0gtIryRrgnAPkw.png" src="https://cdn-images-2.medium.com/max/800/1*atEwskfs0gtIryRrgnAPkw.png"><noscript class="js-progressiveMedia-inner">&lt;img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-2.medium.com/max/800/1*atEwskfs0gtIryRrgnAPkw.png"&gt;</noscript></div></div><figcaption class="imageCaption">Event dispatching within a frame</figcaption></figure><p name="98ab" id="98ab" class="graf--p graf-after--figure graf--last">For more implementation details, Sami’s <a href="https://www.youtube.com/watch?v=nfEeTPntW5E" data-href="https://www.youtube.com/watch?v=nfEeTPntW5E" class="markup--anchor markup--p-anchor" rel="nofollow">Blink Scheduler talk</a> from BlinkOn 3 is worth a watch, and you can poke around the <em class="markup--em markup--p-em">Scheduler Overhaul</em> resources in <a href="https://github.com/ds-hwang/wiki/wiki/Chromium-docs#work-in-progress" data-href="https://github.com/ds-hwang/wiki/wiki/Chromium-docs#work-in-progress" class="markup--anchor markup--p-anchor" rel="nofollow">ds-hwang‘s Chromium-docs</a>.</p></div></div></section>